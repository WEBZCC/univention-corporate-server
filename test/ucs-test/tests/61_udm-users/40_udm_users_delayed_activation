#!/usr/share/ucs-test/runner bash
## desc: Test users/user accountActivationDate
## tags: [udm]
## roles: [domaincontroller_master]
## exposure: dangerous
## packages:
##   - univention-config
##   - univention-directory-manager-tools

. "$TESTLIBPATH/base.sh" || exit 137
. "$TESTLIBPATH/user.sh" || exit 137

eval "$(ucr shell ldap/base)"

now=$(date +'%s')
tz=$(</etc/timezone)
ts_earlier=$(date -d "@$((now))" +"%Y-%m-%d %H:%M $tz")
ts_later=$(date -d "@$((now+120))" +"%Y-%m-%d %H:%M $tz")

name="$(user_randomname)"
password="Univention.1"

## Disable cron job temporarily to avoid unreliable timing due to concurrency
trap 'ucr unset directory/manager/user/accountactivation/cron' EXIT
ucr set directory/manager/user/accountactivation/cron="# */15 *  * * *"

DN="uid=${name},cn=users,$ldap_base"
udm users/user create \
	--position "cn=users,${ldap_base}" \
	--set username="${name}" \
	--set lastname="name" \
	--set password="$password" \
	--set accountActivationDate="$ts_later" || fail_fast 1 "Test user creation failed"

## Verify initial test object state
disabled=$(udm users/user list --filter "uid=${name}" | sed -n 's/^  disabled: //p')
[ "$disabled" = 1 ] || fail_fast 1 "User is not disabled, despite setting future accountActivationDate"
ldapsearch -x -D "$DN" -w "$passowrd" -s base  >/dev/null && fail_fast 1 "LDAP search was successful with disabled user"

## Run the cronjob-script
/usr/share/univention-directory-manager-tools/univention-delayed-account-activation

## Check expectation: User must not be activated yet
disabled=$(udm users/user list --filter "uid=${name}" | sed -n 's/^  disabled: //p')
[ "$disabled" = 1 ] || fail_fast 1 "User is not disabled any longer, after running univention-delayed-account-activation despite future accountActivationDate"

udm users/user modify --dn "$DN" --set accountActivationDate="$ts_earlier" || fail_fast 1 "accountActivationDate coult not be changed"

## Run the cronjob-script again
/usr/share/univention-directory-manager-tools/univention-delayed-account-activation

## Check expectation: User now must be activated
disabled=$(udm users/user list --filter "uid=${name}" | sed -n 's/^  disabled: //p')
[ "$disabled" = 0 ] || fail_fast 1 "User is still disabled, after running univention-delayed-account-activation after accountActivationDate"

## And check that ldapsearch actually works with that account
ldapsearch -x -D "$DN" -w "$passowrd" -s base  >/dev/null || fail_fast 1 "LDAP search was not successful with enabled user"

exit "$RETVAL"
