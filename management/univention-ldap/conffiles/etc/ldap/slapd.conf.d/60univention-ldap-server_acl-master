@!@
from univention.lib.misc import custom_username, custom_groupname

ldap_base = configRegistry['ldap/base']
ldap_port = configRegistry['slapd/port']
priv = 'write' if configRegistry.get('ldap/server/type') == "master" else 'read'

groups_default_domainadmins = custom_groupname('Domain Admins')
users_default_administrator = custom_username('Administrator')

INDENT = f'  %s'
TO_CLAUSE = f'access to\n%s' % INDENT
BY_CLAUSE = INDENT % f'by %s '

print('authz-regexp')
print(INDENT % 'uid=([^,]*),cn=(gssapi|saml),cn=auth')
print(INDENT % f'ldap:///{ldap_base}??sub?uid=$1')
print('')

print(TO_CLAUSE % 'attrs=uid')
print(INDENT % 'value=root')
print(BY_CLAUSE % '* none stop')

print(TO_CLAUSE % 'attrs=userPassword')
print(BY_CLAUSE % 'anonymous auth')
print(BY_CLAUSE % '* none break')
print('')

print(TO_CLAUSE % f'dn="cn=admin,{ldap_base}"')
print(BY_CLAUSE % f'self {priv}')
print(BY_CLAUSE % '* none')
print('')

print(TO_CLAUSE % '*')
print(BY_CLAUSE % f'sockname="PATH=/var/run/slapd/ldapi" {priv}')
if configRegistry['ldap/server/type'] == "slave":
	print(BY_CLAUSE % f'dn.base="cn=admin,{ldap_base}" {priv}')
print(BY_CLAUSE % f'dn.base="uid={users_default_administrator},cn=users,{ldap_base}" {priv}')
print(BY_CLAUSE % '* none break')
print('')

print(TO_CLAUSE % f'dn="uid={users_default_administrator},cn=users,{ldap_base}"')
print(BY_CLAUSE % f'group/univentionGroup/uniqueMember="cn={groups_default_domainadmins},cn=groups,{ldap_base}" {priv}')
if configRegistry['ldap/server/type'] == "slave":
	print(BY_CLAUSE % f'dn.base="cn=admin,{ldap_base}" {priv}')
print(BY_CLAUSE % f'self {priv}')
print(BY_CLAUSE % '* +0 break')
print('')

print(TO_CLAUSE % f'dn="uid=join-backup,cn=users,{ldap_base}"')
print(BY_CLAUSE % f'group/univentionGroup/uniqueMember="cn={groups_default_domainadmins},cn=groups,{ldap_base}" {priv}')
if configRegistry['ldap/server/type'] == "slave":
	print(BY_CLAUSE % f'dn.base="cn=admin,{ldap_base}" {priv}')
print(BY_CLAUSE % f'self {priv}')
print(BY_CLAUSE % '* +0 break')
print('')

print(TO_CLAUSE % f'dn="uid=join-slave,cn=users,{ldap_base}"')
print(BY_CLAUSE % f'group/univentionGroup/uniqueMember="cn={groups_default_domainadmins},cn=groups,{ldap_base}" {priv}')
if configRegistry['ldap/server/type'] == "slave":
	print(BY_CLAUSE % f'dn.base="cn=admin,{ldap_base}" {priv}')
print(BY_CLAUSE % f'self {priv}')
print(BY_CLAUSE % '* +0 break')
print('')

print(TO_CLAUSE % 'attrs=entry,objectClass,uniqueMember,ou,uid,loginShell,homeDirectory,uidNumber,gidNumber,sn,cn,gecos,description,memberUid')
print(BY_CLAUSE % f'group/univentionGroup/uniqueMember="cn={groups_default_domainadmins},cn=groups,{ldap_base}" {priv}')
if configRegistry['ldap/server/type'] == "slave":
	print(BY_CLAUSE % f'dn.base="cn=admin,{ldap_base}" {priv}')
print(BY_CLAUSE % '* +0 break')
print('')

print(TO_CLAUSE % 'attrs=univentionOperatingSystem,univentionOperatingSystemVersion')
print(BY_CLAUSE % f'self {priv}')
print(BY_CLAUSE % '* none break')
print('')
@!@
