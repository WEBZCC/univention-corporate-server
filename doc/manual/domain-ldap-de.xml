<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE chapter [
	<!ENTITY % extensions SYSTEM "../stylesheets/macros.ent" >
	<!ENTITY % DocBookDTD PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
	"http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
	<!ENTITY % entities SYSTEM "../stylesheets/macros-de.ent" >
	%extensions;
	%DocBookDTD;
	%entities;
]>
<chapter id="domaenenkonzept"><title>Domänendienste / LDAP-Verzeichnisdienst</title>

<section id="domain-ldap:Einfuehrung">
	<title>Einführung</title>
	<para>
		Univention Corporate Server bietet ein plattformübergreifendes
		Domänenkonzept mit einem gemeinsamen Vertrauenskontext zwischen Linux- und
		Windows-Systemen. Innerhalb dieser Domäne ist ein Benutzer mit seinem im
		&ucsUMS; hinterlegten Benutzernamen und Passwort auf allen Systemen bekannt,
		und kann für ihn freigeschaltete Dienste nutzen. Das Konto wird über das
		Managementsystem sowohl für die Windows-Anmeldung als auch für
		Linux/POSIX-Systeme und Kerberos synchron gehalten. Die Verwaltung von
		Benutzerkonten ist in <xref linkend="users:general"/> beschrieben.
	</para>
	<para>
		Alle UCS- und Windowssysteme innerhalb einer UCS-Domäne verfügen über ein
		Domänenkonto, sobald sie der UCS-Domäne beigetreten sind. Der Domänenbeitritt
		wird in <xref linkend="domaenenbeitritt"/> beschrieben.
	</para>
	<para>
		Jedes Rechnersystem, das Mitglied einer UCS-Domäne ist, besitzt eine
		Systemrolle. Aus dieser Systemrolle ergeben sich verschiedene Berechtigungen
		und Einschränkungen, die in <xref linkend="systemrollen"/> beschrieben
		sind.
	</para>
	<para>
		Auf dem &ucsPrimaryDN; wird die Certificate Authority (CA) der UCS-Domäne
		betrieben. Dort wird für jedes der Domäne beigetretene System ein
		SSL-Zertifikat generiert. Weitere Informationen finden sich in <xref
		linkend="domain:ssl"/>.
	</para>
	<para>
		Alle domänenweiten Einstellungen werden in einem Verzeichnisdienst auf
		Basis von OpenLDAP vorgehalten. In <xref linkend="domain:ldap"/> wird
		beschrieben wie der Speicherumfang durch LDAP-Schema-Erweiterungen ergänzt
		werden kann, wie eine revisionssichere LDAP-Protokollierung eingerichtet werden
		kann und wie Zugriffsberechtigungen auf das LDAP-Verzeichnis definiert werden
		können.
	</para>
	<para>
		Die Replikation der Verzeichnisdaten innerhalb einer UCS-Domäne erfolgt
		über den Listener/Notifier-Mechanismus. Weitere Informationen finden sich in
		<xref linkend="domain:listenernotifier"/>.
	</para>
	<para>
		Kerberos ist ein Authentikationsverfahren um in verteilten Netzen über
		potentiell unsichere Verbindungen eine sichere Identifikation zu erlauben. Jede
		UCS-Domäne betreibt einen eigenen Kerberosvertrauenskontext (Realm). Weitere
		Informationen finden sich in <xref linkend="domain:kerberos"/>
	</para>
</section>

<section id="domaenenbeitritt">
	<title>Domänenbeitritt</title>
	<para>
		Ein UCS, Ubuntu- oder Windows-System muss nach der Installation der Domäne
		beitreten. Im Folgenden werden die verschiedenen Möglichkeiten hierzu
		vorgestellt.
	</para>

	<para>
	  Neben UCS, Ubuntu und macOS können auch weitere Unix-Systeme in die Domäne integriert
	  werden; dies ist in <biblioref linkend="ext-doc-domain"/> beschrieben.
	</para>

	<section id="linux-domaenenbeitritt">
		<title>Domänenbeitritt von UCS-Systemen</title>
		<para>
			Es gibt drei Möglichkeiten ein UCS-System einer bestehenden Domäne
			beitreten zu lassen; direkt am Ende der Installation im Univention Installer
			(siehe <xref linkend="installation:Domäneneinstellungen:EinerUCSDomäneBeitreten"/>) oder nachträglich durch den
			Befehl <command>univention-join</command> oder mit dem UMC-Module <guimenu>Domänenbeitritt</guimenu>.
		</para>
		<para>
			Der &ucsPrimaryDN; sollte immer auf dem aktuellsten Release-Stand der Domäne
			installiert sein, da beim Join eines Systems in aktuellerer Version gegen einen
			älteren &ucsPrimaryDN; können.
		</para>
		<para>
			Beim Beitritt eines Rechners wird für diesen ein Rechnerkonto angelegt,
			die SSL-Zertifikate synchronisiert und ggf. eine LDAP-Replikation
			angestoßen. Außerdem werden am Ende des Join-Vorgangs
			<emphasis>Join-Skripte</emphasis> ausgeführt. Diese registrieren anhand der auf
			dem System installierten Software-Pakete z.B. weitere Objekte im
			Verzeichnisdienst (siehe <xref linkend="domain-ldap:joinscripts"/>).
		</para>
		<para>
		  Der Domänenbeitritt wird auf Client-Seite in der Logdatei
		  <filename>/var/log/univention/join.log</filename> aufgezeichnet, die zur Fehleranalyse
		  herangezogen werden kann. Auf dem &ucsPrimaryDN; ausgeführte Aktionen werden in der Logdatei
		  <filename>/home/<replaceable>Join-Account</replaceable>/.univention-server-join.log</filename> abgelegt.
		</para>
		<para>
			Der Join-Vorgang kann jederzeit wiederholt werden. Nach bestimmten
			administrativen Schritten (etwa nach Änderungen wichtiger Systemeigenschaften
			auf dem &ucsPrimaryDN;) kann ein erneuter Beitritt der Systeme sogar zwingend
			erforderlich sein.
		</para>

		<section id="domain-ldap:Nachtraeglicher_Domaenenbeitritt_mit_univention-join">
			<title>Nachträglicher Domänenbeitritt mit <command>univention-join</command></title>
			<para>
				<command>univention-join</command> fragt eine Reihe essentieller
				Parameter direkt ab, ist aber auch durch mehrere Parameter konfigurierbar:
			</para>
			<itemizedlist>
				<listitem>
					<simpara>
					Der &ucsPrimaryDN; wird im Regelfall durch eine DNS-Abfrage
					ermittelt. Wenn das nicht möglich sein sollte (z.B. weil ein Standortserver mit
					einer abweichenden DNS-Domäne beitreten soll), lässt sich der Rechnername des
					&ucsPrimaryDN; den Parameter <option>-dcname <replaceable>HOSTNAME</replaceable></option> direkt
					angegeben werden. Der Rechnername muss dabei als vollqualifizierter Name
					angeben werden, also beispielsweise <systemitem class="fqdomainname">primary.firma.de</systemitem>.
					</simpara>
				</listitem>
				<listitem>
					<simpara>
					Als Join-Account wird ein Benutzerkonto bezeichnet, das berechtigt
					ist, Systeme der UCS-Domäne hinzuzufügen. Standardmäßig ist dies der Benutzer
					<systemitem class="username">Administrator</systemitem> oder ein Mitglied der beiden Gruppen
					<systemitem class="groupname">Domain Admins</systemitem> und <systemitem class="groupname">DC Backup Hosts</systemitem>.
					Der Join-Account kann durch den Parameter <option>-dcaccount <replaceable>ACCOUNTNAME</replaceable></option> übergeben werden.
					</simpara>
				</listitem>
				<listitem>
					<simpara>
					Das Passwort kann durch den Parameter <option>-dcpwd <replaceable>DATEI</replaceable></option>
					übergeben werden. Das Passwort wird dabei aus der angegebenen Datei ausgelesen.
					</simpara>
				</listitem>
				<listitem>
					<simpara>
				  Mit dem Parameter <option>-verbose</option> werden zusätzliche Debugausgaben
				  in die Logdateien geschrieben, die die Analyse im Fehlerfall vereinfachen.
					</simpara>
				</listitem>
			</itemizedlist>
		</section>

		<section id="linux-domaenenbeitritt-umc">
			<title>Domänenbeitritt über &ucsUMC; Modul</title>
			<para>
				Der Domänenbeitritt kann auch webbasiert über das UMC-Modul
				<guimenu>Domänenbeitritt</guimenu> erfolgen.
				Da auf einem noch nicht der Domäne beigetretenen System der
				Administrator-Benutzer noch nicht vorhanden ist, muss die Anmeldung am Modul
				als Benutzer <systemitem class="username">root</systemitem> erfolgen.
			</para>
			<para>
				Wie bei der Durchführung über die Kommandozeile sind für Domänenbeitritt
				Benutzername und Passwort eines Benutzers notwendig, der berechtigt ist,
				Rechner der Domäne hinzuzufügen.
				Ebenfalls wird der &ucsPrimaryDN; über eine DNS-Abfrage automatisch ermittelt,
				kann aber auch explizit im angezeigten Dialogfeld eingetragen werden.
			</para>
			<para>
			  Mit der Option <guimenu>Erneut beitreten</guimenu> kann der Domänenbeitritt jederzeit
			  erneut durchgeführt werden.
			</para>
		</section>

		<section id="domain-ldap:joinscripts">
		  <title>Join-Skripte / Unjoin-Skripte</title>

		  <para>
			<emphasis>Join-Skripte</emphasis> werden während des Domänenbeitritts aufgerufen. Beispiele für von
			Join-Skripten vorgenommene Änderungen sind die Registrierung eines Druckservers in der
			Domäne oder die Anpassung von DNS-Einträgen. Die Skripte sind Bestandteil der einzelnen
			Softwarepakete. Analog dazu gibt es <emphasis>Unjoin-Skripte</emphasis>, die nach der
			Deinstallation einer Softwarekomponente diese Änderungen wieder rückgängig machen.
		  </para>

		  <para>
			Join-Skripte werden im Verzeichnis <filename class="directory">/usr/lib/univention-install/</filename>
			und Unjoin-Skripte in <filename class="directory">/usr/lib/univention-uninstall/</filename> gespeichert.
			Jedes Join/Unjoin-Skript verfügt über eine Version. Ein Beispiel: Ein Paket ist bereits installiert
			und das Join-Skript schon aufgerufen. In der neuen Version des Pakets sind nun
			zusätzliche Änderungen nötig und die Versionsnummer des Join-Skripts wird erhöht.
		  </para>

		  <para>
			Mit dem Befehl <command>univention-check-join-status</command> kann geprüft werden, ob
			Join- oder Unjoin-Skripte aufgerufen werden müssen (entweder weil sie noch nie oder in einer älteren
			Version aufgerufen wurde).
		  </para>

		  <section id="domain-ldap:joinscripts:execlater">
			<title>Nachträgliches Ausführen von Join-/Unjoin-Skripten</title>
			<para>
			  Gibt es auf einem System Join- oder Unjoin-Skripte, die noch nicht ausgeführt wurden oder die nur
			  für eine ältere Version ausgeführt wurden, wird beim Öffnen eines UMC-Moduls eine
			  Warnmeldung ausgegeben.
			</para>

			<para>
			  Nicht ausgeführte Join-Skripte können über das UMC-Modul
			  <guimenu>Domänenbeitritt</guimenu> aufgerufen werden, in dem der
			  Menüpunkt <guimenu>Alle Skripte ausführen</guimenu> aufgerufen wird.
			</para>

			<para>
			  Mit dem Befehl <command>univention-run-join-scripts</command> lassen sich alle auf
			  einem System installierten Join-/Unjoin-Skripte ausführen. Ob sie bereits gestartet wurden,
			  prüfen die Skripte selbständig.
			</para>

			<para>
			  Der Name des Join/Unjoin-Skripts und die Skriptausgabe werden auch in
			  <filename>/var/log/univention/join.log</filename> festgehalten.
			</para>

			<para>
			  Wird <command>univention-run-join-scripts</command> auf einer anderen Systemrolle als
			  &ucsPrimaryDN; ausgeführt, so wird der Benutzer nach einem Benutzernamen
			  und einem Passwort gefragt. Auf dem &ucsPrimaryDN; kann dies durch die Option
			  <option>--ask-pass</option> erreicht werden.
			</para>
		  </section>
		</section>
	  </section>

	  <section id="windows-domaenenbeitritt">
		<title>Windows-Domänenbeitritt</title>
		<para>
			Der Domänenbeitritt von Microsoft Windows-Systemen zu einer durch Samba
			bereitgestellten UCS-Domäne wird nachfolgend für Windows 10 und Windows 2012 / 2016 / 2019
			beispielhaft beschrieben. Bei anderen Windows-Versionen funktioniert der
			Beitritt ähnlich. Neben den Client-Versionen können auch Windows Server-Systeme der
			Domäne beitreten. Windows-Server treten der Domäne als Memberserver bei, ein Beitritt
			eines Windows-Systems als Domänencontroller wird nicht unterstützt.
			Weitere Hinweise finden sich in <xref linkend="windows:general"/>.
		</para>
		<para>
			Nur domänenfähige Windows-Versionen können der UCS-Domäne beitreten,
			d.h. ein Domänenbeitritt mit den Home-Versionen von Windows ist nicht möglich.
		</para>
		<para>
			Beim Domänenbeitritt wird automatisch ein Rechnerkonto für den
			Windows-Client erstellt (siehe <xref
			linkend="computers::hostaccounts"/>). Angaben zu MAC- und IP-Adresse, Netzwerk,
			DHCP oder DNS können vor oder nach dem Domänenbeitritt durch UMC-Module ergänzt
			werden.
		</para>
		<para>
			Der Domänenbeitritt wird in der Regel mit dem lokalen Administrator-Konto
			des Windows-Systems durchgeführt.
		</para>
		<para>
			Der Domänenbeitritt dauert einige Zeit und sollte nicht vorzeitig
			abgebrochen werden. Nach einem erfolgreichen Beitritt erscheint ein kleines
			Fenster mit der Nachricht <guimenu>Willkommen in der Domäne
			<replaceable>Domänenname</replaceable></guimenu>, die mit <mousebutton>OK</mousebutton> bestätigt
			werden muss. Abschließend muss der Rechner neu gestartet werden, um die
			Änderungen in Kraft zu setzen.
		</para>
		<para>
			Domänennamen sollten auf 13 Zeichen beschränkt werden, da diese auf Seite
			der Windows-Clients ansonsten verkürzt dargestellt werden, was zu
			Anmeldefehlern führen kann.
		</para>
		<para>
			Bei einem Domänenbeitritt gegen einen Domänencontroller auf Basis von
			Samba/AD muss die DNS-Konfiguration des Clients so eingerichtet sein, dass
			DNS-Einträge aus der DNS-Zone der UCS-Domäne aufgelöst werden können. Außerdem
			muss die Zeit auf dem Client-System mit der Zeit auf dem Domänencontroller
			synchronisiert sein.
		</para>

		<section id="domain-ldap:Windows_10">
			<title>Windows 10</title>
			<para>
			  Der Domänenbeitritt ist nur mit der Pro und Enterprise-Edition von Windows 10 möglich.
			</para>
			<para>
			  Die Systemsteuerung kann über das Suchfeld <guimenu>Web und Windows durchsuchen</guimenu>,
			  welches in der Startleiste zu finden ist gesucht und geöffnet werden. Unter
			  <guimenu>System und Sicherheit &ar; System</guimenu> muss auf
			  <guimenu>Einstellungen ändern &ar; Ändern</guimenu> geklickt werden.
			</para>
			<para>
			  Für den Domänenbeitritt muss das Optionsfeld <guimenu>Domäne</guimenu> markiert und der Name der
			  Domäne in das Eingabefeld eingetragen werden. Es sollte dabei der vollständige Domänenname verwendet
			  werden, bspw.  <guimenu>mydomain.intranet</guimenu>.  Nach einem Klick auf die Schaltfläche
			  <mousebutton>OK</mousebutton> muss in das Eingabefeld <guimenu>Benutzername</guimenu> der
			  Benutzername eines Domänen Administrator, standardmäßig ist dies <systemitem
			  class="username">Administrator</systemitem> und in das Eingabefeld <guimenu>Kennwort</guimenu> das
			  Passwort des Domänen Administrator eingetragen werden.  Abschließend kann der Domänenbeitritt mit
			  einem Klick auf <mousebutton>OK</mousebutton> gestartet werden.
			</para>
		</section>

		<section id="domain-ldap:win2012">
		  <title>Windows Server 2012 / 2016 / 2019</title>
		  <para>
			Die Systemsteuerung kann erreicht werden, indem der Mauszeiger in die rechte untere
			Bildschirmecke bewegt wird. Anschließend kann unter <guimenu>Suchen &ar; Apps</guimenu>
			nach der <emphasis>Systemsteuerung</emphasis> gesucht werden. Unter <guimenu>System und
			Sicherheit &ar; System</guimenu> muss auf <guimenu>Einstellungen ändern &ar; Netzwerk
			ID</guimenu> geklickt werden.
		  </para>

		  <para>
			Für den Domänenbeitritt muss das Optionsfeld <guimenu>Domäne</guimenu> markiert und der
			Name der Samba-Domäne in das Eingabefeld eingetragen werden. Nach einem Klick auf die
			Schaltfläche <mousebutton>OK</mousebutton> muss in das Eingabefeld
			<guimenu>Name</guimenu> der Name <systemitem class="username">Administrator</systemitem> und in das
			Eingabefeld <guimenu>Kennwort</guimenu> das Passwort von
			<uri>uid=Administrator,cn=users,<replaceable>Basis-DN</replaceable></uri> eingetragen
			werden. Abschließend kann der Domänenbeitritt mit einem Klick auf
			<mousebutton>OK</mousebutton> gestartet werden.
		  </para>
		</section>

	</section>

	<section id="ubuntu-domaenenbeitritt">
		<title>Ubuntu-Domänenbeitritt</title>
		<para>
			Univention stellt den <wordasword>Univention Domain Join Assistant</wordasword> für die Integration von Ubuntu-Clients in eine UCS-Domäne bereit.
			Die Dokumentation und Installationshinweise sind auf <ulink url="https://github.com/univention/univention-domain-join">Github</ulink> zu finden.
		</para>
	</section>

	<section id="joining-macos">
		<title>macOS-Domänenbeitritt</title>
		<para>
		  UCS unterstützt den Domänenbeitritt von macOS-Clients in eine UCS-Umgebung mit Samba
		  4. Diese Anleitung bezieht sich auf macOS 10.8.2.
		</para>

		<para>
		  Der Domänenbeitritt kann über das Systemeinstellungsmenü oder den Kommandozeilenbefehl
		  <command>dsconfigad</command> erfolgen.
		</para>

		<para>
		  Nach erfolgtem Domänenbeitritt besteht die Möglichkeit CIFS-Freigaben zu definieren, die
		  bei der Anmeldung eines Benutzers unterhalb von <filename>/Volumes</filename> automatisch
		  eingehängt werden. Um dies zu erreichen, muss die folgende Zeile in die Datei
		  <filename>/etc/auto_master</filename> eingefügt werden:
		</para>
	  <programlisting>
/Volumes    auto_custom
	  </programlisting>

		<para>
		  Außerdem muss die Datei <filename>/etc/auto_custom</filename> angelegt werden und die
		  einzubindenden Freigaben dort in der folgenden Form aufgeführt werden:
		</para>
	  <programlisting>
<replaceable>subfolder name</replaceable>    -fstype=smbfs    ://<replaceable>fqdn</replaceable>/<replaceable>sharename</replaceable>
	  </programlisting>
		<para>
	  Die eingebundenen Freigaben werden nicht in der Seitenleiste des Finders angezeigt.
		</para>

		<section id="joining-macos:gui">
		  <title>Domänenbeitritt über das Systemeinstellungen-Menü</title>
		  <para>
			In den Systemeinstellungen kann über <guimenu>Benutzer</guimenu> das Menü
			<guimenu>Anmeldeoptionen</guimenu> ausgewählt werden. Die Anmeldung erfolgt durch einen
			Klick auf das Schloss in der linken unteren Ecke, dort muss das lokale Administrator-Konto und
			dessen Passwort angegeben und <guimenu>Netzwerk-Account-Server: Verbinden</guimenu>
			angeklickt werden.
		  </para>

		<figure id="domain-ldap:join:osx">
			<title>Domänenbeitritt eines macOS-Systems</title>
			<graphic scalefit="1" width="60%" align="center" fileref="illustrations50/macosx-bind_de.png"/>
		</figure>

		  <para>
			In den erweiterten Einstellungen sollte die Option <guimenu>Mobilen Account bei Anmeldung erstellen</guimenu>
			aktiviert werden. Sie bietet den Vorteil, das auch ohne Verbindung zur Domäne eine
			Anmeldung mit der Domänenbenutzerkennung erfolgen kann
		  </para>

		  <para>
			Der Domänenname muss nun im Feld <guimenu>Active Directory Domain</guimenu> und der
			Rechnername des macOS-Clients in das Feld <guimenu>Computer-ID</guimenu> eingetragen
			werden. Der Domänenbeitritt erfolgt nach einem Klick auf <guimenu>OK</guimenu>. Für den
			Domänenbeitritt muss ein Konto aus der Gruppen <systemitem class="groupname">Domain Admins</systemitem>
			verwendet werden, z.B. <systemitem class="username">Administrator</systemitem>.
		  </para>
		</section>

		<section id="joining-macos:cli">
		  <title>Domänenbeitritt auf den Kommandozeile</title>
		  <para>
			Der Domänenbeitritt kann auch auf der Kommandozeile mit dem Befehl
			<command>dsconfigad</command> erfolgen:
		  </para>
	    <programlisting language="sh">
dsconfigad -a <replaceable>mac hostname</replaceable> -domain <replaceable>fqdn</replaceable> -ou "CN=Computers,<replaceable>ldap_base</replaceable>" \
  -u <replaceable>Domain Administrator</replaceable> -mobile enable
	    </programlisting>
		  <para>
	    Weitere Optionen werden mit <command>dsconfigad -help</command> angezeigt.
		  </para>
		</section>
	</section>
</section>

<section id="systemrollen">
	<title>UCS-Systemrollen</title>
	<para>
		In einer UCS-Domäne können Systeme in unterschiedlichen
		<emphasis>Systemrollen</emphasis> installiert werden. Im Folgenden werden die
		verschiedenen Systemrollen kurz charakterisiert:
	</para>

	<section id="domain-ldap:Primary_Directory_Node">
		<title>&ucsPrimaryDN;</title>
		<para>
			Ein System mit der Rolle &ucsPrimaryDN; ist das führende System
			einer UCS-Domäne und wird immer als erstes System
			installiert. Auf dem &ucsPrimaryDN; werden die Domänendaten (wie z.B. Benutzer,
			Gruppen, Drucker) und die SSL-Sicherheitszertifikate gespeichert. Kopien
			dieser Daten werden automatisch auf Server mit der Rolle &ucsBackupDN;
			übertragen.
		</para>
	</section>

	<section id="domain-ldap:Backup_Directory_Node">
		<title>&ucsBackupDN;</title>
		<para>
			Auf Servern mit der Rolle &ucsBackupDN; werden alle
			Domänendaten und SSL-Sicherheitszertifikate als Nur-Lese-Kopie gespeichert.
		</para>
		<para>
			Der &ucsBackupDN; dient als Fallback-System des &ucsPrimaryDN;. Sollte dieser
			ausfallen, kann ein &ucsBackupDN; die Rolle des &ucsPrimaryDN; dauerhaft übernehmen
			(siehe <xref linkend="domain:backup2master"/>).
		</para>
	</section>

	<section id="domain-ldap:Replica_Directory_Node">
		<title>&ucsReplicaDN;</title>
		<para>
			Auf Servern mit der Rolle &ucsReplicaDN; werden die
			Domänendaten als Nur-Lese-Kopie gespeichert. Im Gegensatz zum &ucsBackupDN; werden
			jedoch nicht alle SSL-Sicherheitszertifikate gespeichert. Da die Zugriffe der
			auf einem &ucsReplicaDN; laufenden Dienste gegen den lokalen LDAP-Datenbestand
			erfolgen, bieten sich &ucsReplicaDN;s für Standortserver und für die Verteilung
			lastintensiver Dienste an.
		</para>
		<para>
			Ein &ucsReplicaDN; kann nicht zum &ucsPrimaryDN; hochgestuft werden.
		</para>
	</section>

	<section id="domain-ldap:Managed_Node">
		<title>&ucsManagedNode;</title>
		<para>
			&ucsManagedNode; sind Server-Systeme ohne lokalen LDAP-Server. Der Zugriff auf
			Domänendaten erfolgt hierbei über andere Server der Domäne.
		</para>
	</section>

	<section id="domain-ldap:Ubuntu">
		<title>Ubuntu</title>
		<para>
			Ubuntu-Clients können mit einer eigenen Systemrolle verwaltet werden,
			siehe <xref linkend="computers:ubuntu"/>.
		</para>
	</section>

	<section id="domain-ldap:Linux">
		<title>Linux</title>
		<para>
		  Diese Systemrolle wird für die Integration von anderen Linux-Systemen als UCS und Ubuntu
		  verwendet, z.B. für Debian- oder CentOS-Systeme. Die Integration wird in <biblioref
		  linkend="ext-doc-domain"/> beschrieben.
		</para>
	</section>

	<section id="domain-ldap:macos">
	  <title>macOS</title>
	  <para>
		macOS-Systeme können einer UCS-Domäne mit Samba/AD beitreten. Weitere Hinweise finden sich
		in <xref linkend="joining-macos"/>.
	  </para>
	</section>

	<section id="domain-ldap:Domain_Trust_Account">
		<title>Domain Trust Account</title>
		<para>
			Ein Domain Trust Account wird für Vertrauensstellungen zwischen Windows
			und UCS Domänen eingerichtet.
		</para>
	</section>

	<section id="domain-ldap:IP-Managed-Client">
		<title>IP-Client</title>
		<para>
			Ein IP-Client ermöglicht die Integration von Nicht-UCS-Systemen
			in das IP-Management (DNS/DHCP), z.B. für Netzwerkdrucker oder Router.
		</para>
	</section>

	<section id="domain-ldap:Windows_Domaenencontroller">
		<title>Windows Domänencontroller</title>
		<para>
			Windows-Domänencontroller in einer Samba/AD-Umgebung werden mit dieser
			Systemrolle betrieben.
		</para>
	</section>

	<section id="domain-ldap:Windows_Workstation_Server">
		<title>Windows Workstation/Server</title>
		<para>
			Windows-Clients und Windows-Memberserver werden mit dieser Systemrolle
			verwaltet.
		</para>
	</section>
</section>

<section id="domain:ldap">
	<title>LDAP-Verzeichnisdienst</title>
	<para>
	  Univention Corporate Server speichert domänenweit vorgehaltene Daten in einem
	  LDAP-Verzeichnisdienst auf Basis von OpenLDAP. Dieses Kapitel beschreibt die weitergehende
	  Konfiguration und Anpassung von OpenLDAP.
	</para>

	<para>
	  In einer UCS-Domäne werden oft mehrere LDAP-Server betrieben. Die Konfiguration des/der
	  verwendeten Server(s) wird in <xref linkend="computers:configureldapserver"/> beschrieben.
	</para>

	<section id="domain:ldap:schemata">
		<title>LDAP-Schemata</title>
		<para>
			In Schema-Definitionen wird festgelegt, welche Objektklassen existieren
			und welche Attribute darin enthalten sind - mit anderen Worten, welche Daten in
			einem Verzeichnisdienst gespeichert werden können. Schema-Definitionen liegen
			als Text-Dateien vor und werden über die Konfigurationsdatei des
			OpenLDAP-Servers eingebunden.
		</para>
		<para>
			UCS verwendet nach Möglichkeit Standard-Schemata, so dass eine
			Interoperabilität mit anderen LDAP-Applikationen in der Regel gegeben ist. Für
			Univention-spezifische Attribute - etwa für den Richtlinien-Mechanismus -
			werden Schema-Erweiterungen mitgeliefert.
		</para>

		<section id="domain:ldap:extensions">
			<title>LDAP-Schema-Erweiterungen</title>
			<para>
				Um den Aufwand für kleine Erweiterungen im LDAP möglichst gering zu
				halten, bringt UCS ein eigenes LDAP-Schema für Kundenerweiterungen mit. Die
				LDAP-Objektklasse <classname>univentionFreeAttributes</classname> kann ohne
				Einschränkungen für erweiterte Attribute verwendet werden. Sie bringt 20 frei
				zu verwendende Attribute (<property>univentionFreeAttribute1</property> bis
				<property>univentionFreeAttribute20</property>) mit und kann in Verbindung mit
				jedem beliebigen LDAP-Objekt (z.B. einem Benutzerobjekt) verwendet werden.
			</para>

			<para>
			  Wenn LDAP-Schema-Erweiterungen als Teil von Softwarepaketen ausgeliefert werden sollen,
			  besteht auch die Möglichkeit diese zu paketieren und durch ein &ucsUDL;-Modul
			  an alle &ucsBackupDN;s der Domäne zu verteilen. Weitere Hinweise finden sich
			  in <xref linkend="packaging-schema-extensions"/>.
			</para>

		</section>

		<section id="domain-ldap:LDAP-Schema-Replikation">
			<title>LDAP-Schema-Replikation</title>
			<para>
				Über den Listener/Notifier-Mechanismus (siehe <xref
				linkend="domain:listenernotifier"/>) wird auch die Replikation der
				LDAP-Schemata automatisiert. Dies entbindet den Administrator von der
				Notwendigkeit, Schema-Änderungen auf allen OpenLDAP-Servern der Domäne manuell
				nachzupflegen. Mit der Ausführung der Schema-Replikation vor der Replikation
				von LDAP-Objekten wird sichergestellt, dass diese nicht aufgrund fehlender
				Objektklassen oder Attribute scheitert.
			</para>
			<para>
				Auf dem &ucsPrimaryDN; wird beim Start des OpenLDAP-Servers über alle
				Verzeichnisse mit Schema-Definitionen eine Prüfsumme erzeugt. Diese Prüfsumme
				wird mit der letzten in der Datei
				<filename>/var/lib/univention-ldap/schema/md5</filename> gespeicherten
				Prüfsumme verglichen.
			</para>

			<para>
				Die eigentliche Replikation der Schema-Definitionen wird vom &ucsUDL;
				initiiert. Vor jeder Abfrage einer neuen Transaktion-ID
				durch den &ucsUDN; wird dessen aktuelle Schema-ID
				abgefragt. Ist diese höher als die Schema-ID auf der Listener-Seite, wird über
				eine LDAP-Suche vom LDAP-Server des Notifier-Systems dessen aktuell verwendetes
				Subschema bezogen.
			</para>
			<para>
				Das ausgelesene Subschema wird auf dem Listener-System im LDIF-Format
				in die Datei <filename>/var/lib/univention-ldap/schema.conf</filename>
				eingebunden und der lokale OpenLDAP-Server neu gestartet. Ist die
				Schema-Replikation mit diesem Schritt abgeschlossen, wird die Replikation der
				LDAP-Objekte fortgeführt.
			</para>
		</section>
	</section>

	<section id="domain-ldap:directorylogger">
		<title>Revisionssichere LDAP-Protokollierung</title>
		<para>
		  Das Paket <package>univention-directory-logger</package> ermöglicht die Protokollierung
		  von Änderungen im LDAP-Verzeichnisdienst. Da jeder Datensatz den Hash-Wert des
		  vorhergehenden Datensatzes enthält, können Manipulationen an der Logdatei - etwa entfernte
		  Einträge - aufgedeckt werden.
		</para>

		<para>
		  Einzelne Teilbereiche des Verzeichnisdienstes können von der Protokollierung ausgenommen
		  werden. Diese Zweige können durch die &ucsUCR;-Variablen
		  <envar>ldap/logging/exclude1</envar>, <envar>ldap/logging/exclude2</envar>
		  etc. konfiguriert werden. Standardmässig ist der Container exkludiert, in dem die
		  temporären Objekte gespeichert werden (<uri>cn=temporary,cn=univention</uri>).
		  Die Protokollierung der LDAP-Änderungen erfolgt durch ein
		  &ucsUDL;-Modul, nach &ucsUCR;-Änderungen muss der &ucsUDL;-Dienst neu
		  gestartet werden.
		</para>

		<para>
		  Die Protokollierung erfolgt in die Datei
		  <filename>/var/log/univention/directory-logger.log</filename> im folgenden Format:

		  <screen>
START
Old Hash: Hashsumme des vorhergehenden Datensatzes
DN: DN des LDAP-Objekts
ID: Listener/Notifer-Transaktions-ID
Modifier: DN des ändernden Kontos
Timestamp: Zeitstempel im Format dd.mm.yyyy hh:mm:ss
Action: add, modify oder delete

Old Values:
 Liste der alten Attribute, ist leer wenn ein Objekt hinzugefügt wird
New Values:
 Liste der neuen Attribute, ist leer wenn ein Objekt gelöscht wird
END
		</screen>

		Für jeden protokollierten Datensatz wird eine Hashsumme berechnet und zusätzlich in die
		Sektion <wordasword>daemon.info</wordasword> des Syslog-Dienstes protokolliert.
		</para>
		<para>
			Ab <u:erratum release="4.4-4">536</u:erratum> wird in der Datei <filename>/var/log/univention/directory-logger.log</filename> vor jede Zeile als Präfix die jeweilige Transaktions-ID des Eintrags hinzugefügt:
			<screen>
ID 342: START
ID 342: Old Hash: 70069d51a7e2e168d7c7defd19349985
ID 342: DN: uid=Administrator,cn=users,dc=example,dc=com
ID 342: ID: 342
ID 342: Modifier: cn=admin,dc=example,dc=com
ID 342: Timestamp: 15.04.2020 09:20:40
ID 342: Action: modify
ID 342:
ID 342: Old values:
ID 342: description: Dhis is a description test
ID 342: entryCSN: 20200415091936.317108Z#000000#000#000000
ID 342: modifyTimestamp: 20200415091936Z
ID 342:
ID 342: New values:
ID 342: description: This is a description test
ID 342: entryCSN: 20200415092040.430976Z#000000#000#000000
ID 342: modifyTimestamp: 20200415092040Z
ID 342: END
			</screen>
			Wurde <package>univention-directory-logger</package> vor dieser UCS-Version installiert, wird per Default das alte Verhalten (kein Präfix) beibehalten.
			Durch das Setzen der &ucsUCRV; <envar>ldap/logging/id-prefix=yes</envar> kann das neue Verhalten aktiviert werden.
			Dieses Präfix erleichtert eine Korrelation der zusammenhängenden Zeilen bei einer Weiterverarbeitung des Protokolls in Analyse- und Monitoring-Software.
		</para>
	</section>

	<section id="domain-ldap:Timeout_fuer_inaktive_LDAP-Verbindungen">
		<title>Timeout für inaktive LDAP-Verbindungen</title>
		<para>
			Mit der &ucsUCRV; <envar>ldap/idletimeout</envar> kann ein Zeitraum in
			Sekunden konfiguriert werden, nach dessen Ablauf eine LDAP-Verbindung
			serverseitig geschlossen wird. Wenn der Wert auf 0 gesetzt wird, wird kein
			Ablaufzeitraum angewendet. Der Ablaufzeitraum beträgt
			standardmäßig sechs Minuten.
		</para>
	</section>

	<section id="domain-ldap:LDAP-Kommandozeilen-Tools">
		<title>LDAP-Kommandozeilen-Tools</title>
		<para>
			Neben den UMC-Modulen gibt es auch eine Reihe von Programmen,
			mit denen auf der Kommandozeile auf das LDAP-Verzeichnis zugegriffen werden
			kann.
		</para>
		<para>
			Das Tool <command>univention-ldapsearch</command> vereinfacht die
			authentifizierte Suche im LDAP-Verzeichnis. Als Argument muss ein Suchfilter
			übergeben werden, im folgenden Beispiel wird der Administrator anhand der
			User-ID gesucht:
		</para>
		<programlisting language="sh">
univention-ldapsearch uid=Administrator
		</programlisting>
		<para>
			Der Befehl <command>slapcat</command> ermöglicht die Speicherung der
			aktuellen LDAP-Daten in einer Textdatei im LDIF-Format, z.B.:
		</para>
		<programlisting language="sh">
slapcat &gt; ldapdaten.txt
		</programlisting>
	</section>

	<section id="domain-ldap:acls">
		<title>Zugriffskontrolle auf das LDAP-Verzeichnis</title>
		<para>
			Der Zugriff auf die Informationen im LDAP-Verzeichnis wird serverseitig
			durch Access Control Lists (ACLs) geregelt. Die ACLs werden in der zentralen
			Konfigurationsdatei <filename>/etc/ldap/slapd.conf</filename> definiert und
			über &ucsUCR; verwaltet. Die <filename>slapd.conf</filename> wird dabei durch
			ein Multifile-Template verwaltet; weitere ACL-Elemente können unterhalb von
			<filename class="directory">/etc/univention/templates/files/etc/ldap/slapd.conf.d/</filename>
			zwischen den Dateien <filename>60univention-ldap-server_acl-master</filename>
			und <filename>70univention-ldap-server_acl-master-end</filename> eingefügt
			werden oder die bestehenden Templates erweitert werden.
		</para>

		<para>
		  Wenn LDAP-ACL-Erweiterungen als Teil von Softwarepaketen ausgeliefert werden sollen,
		  besteht auch die Möglichkeit diese zu paketieren und durch ein
		  &ucsUDL;-Modul an alle LDAP-Server der Domäne zu verteilen. Weitere Hinweise finden sich
		  in <xref linkend="packaging-acl-extensions"/>.
		</para>

		<para>
			Die Grundeinstellung des LDAP-Servers bei Neuinstallationen mit UCS
			erlaubt keinen anonymen Zugriff auf das LDAP-Verzeichnis. Dieses Verhalten kann
			mit der &ucsUCRV; <envar>ldap/acl/read/anonymous</envar> konfiguriert
			werden. Einzelne IP-Adressen können über die &ucsUCRV;
			<envar>ldap/acl/read/ips</envar> für den anonymen Lesezugriff freigeschaltet
			werden.
		</para>
		<para>
			Nach erfolgreicher Authentifizierung am LDAP-Server können alle Attribute
			eines Benutzerkontos von diesem Benutzer ausgelesen werden.
		</para>
		<para>
			Ein zusätzlicher, interner Account, der Root-DN, besitzt darüber hinaus
			auch schreibenden Vollzugriff.
		</para>
		<para>
			Unter UCS gibt es außerdem einige standardmäßig installierte ACLs,
			die den Zugriff auf sensitive Daten unterbinden (z.B. auf das Benutzerpasswort)
			und für den Betrieb notwendige Regeln setzen (etwa nötige Zugriffe auf
			Rechnerkonten für Anmeldungen). Der lesende und schreibende Zugriff auf diese
			sensitiven Daten ist nur für die Mitglieder der Gruppe <systemitem class="groupname">Domain
			Admins</systemitem> vorgesehen. Dabei werden auch enthaltene Gruppen
			unterstützt. Mit der &ucsUCRV; <envar>ldap/acl/nestedgroups</envar> kann diese
			Gruppen-in-Gruppen-Funktionalität für die LDAP-ACLs deaktiviert werden, wodurch
			eine Geschwindigkeitssteigerung bei den Verzeichnisdienstanfragen zu erwarten
			ist.
		</para>

		<section id="domain-ldap:Delegation_des_Zuruecksetzens_von_Benutzerpasswoertern">
			<title>Delegation des Zurücksetzens von Benutzerpasswörtern</title>
			<para>
				Um einer Teilgruppe von Administratoren mit eingeschränkten Rechten,
				z.B. einem Helpdesk, das Zurücksetzen von Benutzerpasswörtern zu ermöglichen,
				kann das Paket <package>univention-admingrp-user-passwordreset</package>
				installiert werden. Es legt über ein Joinskript die Benutzergruppe
				<systemitem class="groupname">User Password Admins</systemitem> an, sofern diese noch nicht
				existiert.
			</para>
			<para>
				Mitglieder dieser Gruppe erhalten über zusätzliche LDAP-ACLs die
				Berechtigung, Passwörter von anderen Benutzern zurückzusetzen. Diese LDAP-ACLs
				werden bei der Paketinstallation automatisch aktiviert. Um eine andere
				ggf. schon existierende Gruppe statt der Gruppe <systemitem class="groupname">User Password
				Admins</systemitem> zu verwenden, kann der DN der zu verwendenden Gruppe in die
				&ucsUCRV; <envar>ldap/acl/user/passwordreset/accesslist/groups/dn</envar>
				eingetragen werden. Nach der Änderung ist ein Neustart des LDAP-Servers
				erforderlich.
			</para>
			<para>
				Passwörter können über das UMC-Modul <guimenu>Benutzer</guimenu> zurückgesetzt werden.
				In der Standardeinstellung wird das Modul nur dem Benutzer
				<systemitem class="username">Administrator</systemitem> angezeigt.
				Während der Installation wird automatisch
				eine neue Richtlinie <uri>default-user-password-admins</uri> erstellt,
				die den Mitgliedern der Gruppe <systemitem class="groupname">User Password Admins</systemitem>
				zugewiesen ist bzw. mit einem entsprechenden Container im LDAP-Verzeichnis
				verknüpft werden kann. Weitere Hinweise zur Konfiguration von UMC-Richtlinien finden
				sich in Kapitel <xref linkend="delegated-administration"/>.
			</para>
			<para>
				Die Richtlinie ermöglicht dabei die Suche nach Benutzern sowie die
				Ansicht aller Attribute eines Benutzerobjektes. Wird versucht, neben dem
				Passwort weitere Attribute zu modifizieren, für die keine ausreichenden
				Zugriffsrechte auf das LDAP-Verzeichnis existieren, wird der Schreibzugriff vom
				&ucsUDM; mit der Meldung <emphasis>Zugriff verweigert</emphasis> abgelehnt.
			</para>
			<caution>
				<para>
					Das Paket ist auf dem &ucsPrimaryDN; sowie den
					&ucsBackupDN;s zu installieren. Während der Installation wird
					der LDAP-Server neu gestartet und ist kurzzeitig nicht erreichbar.
				</para>
			</caution>

			<para>
			  Das Zurücksetzen der Passwörter durch die Passwort-Gruppe kann für sensible Benutzer oder Gruppen
			  (z.B. Domänen-Administratoren) verhindert werden. Mit den &ucsUCR;-Variablen
			  <envar>ldap/acl/user/passwordreset/protected/uid</envar> und
			  <envar>ldap/acl/user/passwordreset/protected/gid</envar> können Benutzer und Gruppen
			  konfiguriert werden. Mehrere Werte müssen durch Kommas getrennt werden. Nach
			  Änderungen an den Variable ist es erforderlich, den LDAP-Server über den Befehl
			  <command>systemctl restart slapd</command> neu zu starten. In der
			  Standardeinstellung werden die Mitglieder der Gruppe <systemitem class="groupname">Domain
			  Admins</systemitem> vor Passwortänderungen geschützt.
			</para>

			<para>
				Sollte für die Änderung des Passworts der Zugriff auf zusätzliche
				LDAP-Attribute notwendig sein, können die Attributnamen in der &ucsUCRV;
				<envar>ldap/acl/user/passwordreset/attributes</envar> ergänzt werden. Nach der
				Änderung ist zur Übernahme ein Neustart des LDAP-Verzeichnisdienstes
				notwendig. Für eine UCS-Standard-Installation ist diese Variable bereits
				passend gesetzt.
			</para>
		</section>
	</section>

	<section id="domain-ldap:Name_Service_Switch__LDAP-NSS-Modul">
		<title>Name Service Switch / LDAP-NSS-Modul</title>
		<para>
			Die in Univention Corporate Server verwendete GNU C-Standardbibliothek
			(<package>glibc</package>) bietet eine modulare Schnittstelle zur Auflösung von Namen von
			Benutzern, Gruppen und Rechnern, den <emphasis>Name Service Switch</emphasis>.
		</para>
		<para>
			Das LDAP-NSS-Modul wird auf UCS-Systemen standardmäßig für den Zugriff
			auf die Domänen-Daten (z.B. Benutzer) verwendet. Das Modul greift dabei auf den
			in der &ucsUCRV; <envar>ldap/server/name</envar> (und ggf. zusätzlich der
			<envar>ldap/server/addition</envar>) festgelegten LDAP-Server zu.
		</para>
		<para>
			Das Verhalten bei nicht erreichbarem LDAP-Server kann durch die &ucsUCRV;
			<envar>nssldap/bindpolicy</envar> festgelegt werden. Standardmäßig wird bei
			nicht erreichbarem Server eine erneute Verbindung aufgebaut. Wird die Variable
			auf <literal>soft</literal> gesetzt, wird kein erneuter Verbindungsaufbau
			durchgeführt. Dies kann den Boot eines Systems mit nicht erreichbarem
			LDAP-Server - z.B. in einer abgeschottenen Testumgebung - deutlich
			beschleunigen.
		</para>
	</section>

	<section id="domain:ldap:syncrepl">
		<title>Syncrepl zur Anbindung von Nicht-UCS OpenLDAP-Servern</title>
		<para>
			Für die Anbindung von nicht auf UCS-Systemen installierten
			OpenLDAP-Servern an das UCS-Managementsystem kann parallel zum Notifier-Dienst
			der Syncrepl-Replikations-Dienst aktiviert werden. Dieser ist Bestandteil von
			OpenLDAP, registriert Veränderungen im lokalen Verzeichnisdienst und überträgt
			diese auf weitere OpenLDAP-Server.
		</para>

		<!-- Can be re-integrated once the article has been updated to UCS 3.x -->
		<!-- <para> -->
		<!--	Die Einrichtung ist in der Univention Supportdatenbank unter -->
		<!--	<u:sdb>1120</u:sdb> beschrieben. -->
		<!-- </para> -->
	</section>

	<section id="domain-ldap:Konfiguration_des_Verzeichnis-Dienstes_bei_Verwendung_von_Samba_4">
		<title>Konfiguration des Verzeichnis-Dienstes bei Verwendung von Samba/AD</title>
		<para>
			Standardmäßig ist der OpenLDAP-Server so konfiguriert, dass er
			zusätzlich zu den Standard-Ports 389 und 636 auch auf den Ports 7389 und 7636
			Anfragen entgegennimmt.
		</para>
		<para>
			Wird Samba/AD eingesetzt, belegt der Dienst Samba/AD-Domänencontroller die
			Ports 389 und 636. In diesem Fall wird OpenLDAP automatisch umkonfiguriert, so
			dass nur noch die Ports 7389 und 7636 eingesetzt werden. Dies ist insbesondere
			bei der Konfiguration von syncrepl zu beachten (siehe <xref
			linkend="domain:ldap:syncrepl"/>). <command>univention-ldapsearch</command>
			verwendet automatisch den Standard-Port.
		</para>
	</section>

	<section id="domain-ldap:nightlybackup">
	  <title>Tägliche Sicherung der LDAP-Daten</title>
	  <para>
		Auf dem &ucsPrimaryDN; und allen &ucsBackupDN;s wird der Inhalt des LDAP-Verzeichnisses
		durch einen Cron-Job täglich gesichert.  Falls Samba 4 eingesetzt wird, wird auch dessen
		Daten-Verzeichnis gesichert.
	  </para>

	  <para>
		Die LDAP-Daten werden im LDIF-Format im Verzeichnis <filename class="directory">/var/univention-backup/</filename> im
		Namensschema <filename>ldap-backup_DATUM.ldif.gz</filename> gespeichert. Sie sind nur für
		den Benutzer <systemitem class="username">root</systemitem> lesbar. Die Samba 4 Backup-Dateien werden im
		Verzeichnis <filename class="directory">/var/univention-backup/samba/</filename> gesichert.
	  </para>

	  <para>
		Mit der &ucsUCRV; <envar>backup/clean/max_age</envar> kann definiert werden, wie lange alte Backup-Dateien
		aufgehoben werden (z.B. <envar>backup/clean/max_age=365</envar>, alle Dateien älter als 365 Tage werden automatisch gelöscht).
		Diese Variable wird bei Neuinstallationen ab UCS 4.4-7 automatisch auf 365 gesetzt. Falls die Variable nicht
		gesetzt ist, werden keine Backup-Dateien gelöscht.
	  </para>

	</section>

</section>

<section id="domain:listenernotifier">
	<title>Listener/Notifier-Domänenreplikation</title>

	<section id="domain:listenernotifier:intro">
	  <title>Ablauf der Listener/Notifier-Replikation</title>
	  <para>
		Die Replikation der Verzeichnisdaten innerhalb einer UCS-Domäne erfolgt über den &ucsUDL;/Notifier-Mechanismus:

		<itemizedlist>
		  <listitem> <simpara>
			Der <emphasis>&ucsUDL;</emphasis>-Dienst läuft auf jedem UCS-System.
		  </simpara></listitem>

		  <listitem><simpara>
			Auf dem &ucsPrimaryDN; (und eventuell vorhandenen &ucsBackupDN;s) überwacht der
			<emphasis>&ucsUDN;</emphasis>-Dienst Änderungen im LDAP-Verzeichnis und stellt die
			aufgezeichneten Änderungen transaktionsbasiert den &ucsUDL;-Diensten auf den
			weiteren UCS-Systemen zur Verfügung.
		  </simpara></listitem>
		</itemizedlist>
	  </para>

	  <figure id="domain-join:listener-notifier">
		<title>Listener/Notifier-Mechanismus</title>
		<graphic scalefit="1" width="80%" align="center" fileref="illustrations50/administration-overview.png"/>
	  </figure>

	  <para>
		Die aktiven &ucsUDL;-Instanzen der Domäne verbinden sich zu einem &ucsUDN;-Dienst.
		Wird auf dem &ucsPrimaryDN; eine LDAP-Änderung durchgeführt (alle
		anderen LDAP-Server der Domäne sind nur lesend), wird diese durch den &ucsUDN;
		registriert und an die Listener-Instanzen gemeldet.
	  </para>

	  <para>
		Jede &ucsUDL;-Instanz verwendet eine Reihe von &ucsUDL;-Modulen.
		Diese Module werden von den installierten Applikationen mitgeliefert, das
		Druckserver-Paket bringt z.B Listener-Module mit, die die CUPS-Konfiguration erzeugen.
	  </para>

	  <para>
		Durch &ucsUDL;-Module können Änderungen an der Domäne auch an Dienste übermittelt werden,
		die selbst nicht LDAP-fähig sind. Ein Beispiel ist der Druckserver CUPS: Die
		Druckerdefinitionen werden nicht aus dem LDAP ausgelesen, sondern aus der Datei
		<filename>/etc/cups/printers.conf</filename>. Wird nun im UMC-Modul <guimenu>Drucker</guimenu>
		ein Drucker angelegt, wird dieser im LDAP registriert. Diese
		Änderung wird dann vom &ucsUDL;-Modul <emphasis>cups-printers</emphasis> erkannt und
		basierend auf den Daten im LDAP ein Eintrag in
		<filename>/etc/cups/printers.conf</filename> hinzugefügt, modifiziert oder gelöscht.
	  </para>

	  <para>
		Weitergehende Informationen zum Aufbau von &ucsUDL;-Modulen und zur Entwicklung eigener
		Module finden sich in <xref linkend="developer-reference"/>.
	  </para>

	  <para>
		Die LDAP-Replikation erfolgt ebenfalls durch ein Listener-Modul. Ist der LDAP-Server zu dem
		repliziert werden soll nicht erreichbar, werden die LDAP-Änderungen in der Datei
		<filename>/var/lib/univention-directory-replication/failed.ldif</filename>
		zwischengespeichert. Der Inhalt dieser Datei wird beim späteren Start des LDAP-Servers automatisch in
		das LDAP übertragen.
	  </para>

	  <para>
		Der Listener/Notifier-Mechanismus arbeitet transaktionsbasiert. Für jede Änderung im
		LDAP-Verzeichnis des &ucsPrimaryDN; wird eine Transaktions-ID erhöht. Eine &ucsUDL;-Instanz,
		die mehrere Transaktionen verpasst hat - weil zum Beispiel der Rechner
		ausgeschaltet war - fragt bei erneuter Verfügbarkeit der Verbindung automatisch alle
		fehlenden Transaktionen ab, bis seine lokale Transaktions-ID der des &ucsPrimaryDN; entspricht.
	  </para>
	</section>

	<section id="domain:listenernotifier:erroranalysis">
	  <title>Analyse von Listener/Notifier-Problemen</title>

	  <section id="domain:listenernotifier:erroranalysis:debug">
		<title>Logdateien/Debug-Level der Replikation</title>

		<para>
		  Alle Statusmeldungen des &ucsUDL; und der aufgerufenen
		  Listener-Module werden in die Datei <filename>/var/log/univention/listener.log</filename>
		  protokolliert. Der Detailgrad der Logmeldungen kann über die &ucsUCRV;
		  <envar>listener/debug/level</envar> konfiguriert werden. Mögliche Werte reichen von 0
		  (nur Fehlermeldungen) bis 4 (alle Statusmeldungen). Nachdem der Debuglevel geändert
		  wurde, muss der &ucsUDL; neu gestartet werden.
		</para>

		<para>
		  Statusmeldungen des &ucsUDN;-Dienstes werden in die Datei
		  <filename>/var/log/univention/notifier.log</filename> protokolliert. Der Debuglevel kann mit der
		  Variable <envar>notifier/debug/level</envar> konfiguriert werden (ebenfalls von 0-4).
		  Nachdem der Debuglevel geändert  wurde, muss der &ucsUDN; neu gestartet werden.
		</para>
	  </section>

	  <section id="domain:listenernotifier:erroranalysis:replication">
		<title>Erkennung von Replikationsproblemen</title>

		<para>
		  Im Regelbetrieb der Domänenreplikation (keine hohe Last auf den Systemen, keine Störungen
		  im Netzwerk) ist die Verzögerung zwischen Änderungen in UMC-Modulen bis zur
		  Replikation auf z.B. eines &ucsReplicaDN; kaum merkbar. Eine möglicherweise unvollständige
		  Replikation kann durch einen Vergleich der Transaktions-IDs von Listener- und
		  Notifier-Dienst identifiziert werden.
		</para>

		<para>
		  Auf dem &ucsPrimaryDN; werden die vom Notifier-Dienst registrierten Transaktionen in
		  aufsteigender Reihenfolge in die Datei
		  <filename>/var/lib/univention-ldap/notify/transaction</filename> geschrieben. Ein
		  Beispiel:

		  <screen>
root@primary:~# tail -1 /var/lib/univention-ldap/notify/transaction
836 cn=replica3,cn=dc,cn=computers,dc=firma,dc=de m
		  </screen>

		  Auf dem Listener-System wird die zuletzt vom Listener empfangene Transaktion in der Datei
		  <filename>/var/lib/univention-directory-listener/notifier_id</filename> gespeichert:

		  <screen>
root@replica1:~# cat /var/lib/univention-directory-listener/notifier_id
836
		  </screen>

		  Diese Prüfung kann auch automatisiert durch den Nagios-Dienst <systemitem class="service">UNIVENTION_REPLICATION</systemitem>
		  durchgeführt werden (siehe <xref linkend="nagios:preconfiguredchecks"/>).
		</para>
	  </section>


	  <section id="domain:listenernotifier:erroranalysis:reinit">
		<title>Neuinitialiisierung von Listener-Modulen</title>

		<para>
		  Falls es zu Problemen bei der Abarbeitung eines Listener-Moduls gekommen ist, besteht die
		  Möglichkeit, das Modul neu zu initialisieren. Dabei werden alle LDAP-Objekte mit
		  denen das Listener-Modul arbeitet erneut übergeben.
		</para>

		<para>
		  Dem Befehl zum erneuten Initialisieren muss der Name des Listener-Moduls übergeben
		  werden. Die installierten Listener-Module sind im Verzeichnis
		  <filename class="directory">/var/lib/univention-directory-listener/handlers/</filename> zu finden.
		</para>

		<para>
		  Mit dem folgenden Befehl kann beispielsweise das Druckermodul neu initialisiert werden:

		  <programlisting language="sh">
univention-directory-listener-ctrl resync cups-printers
		  </programlisting>
		</para>
	  </section>
	</section>

</section>

<section id="domain:ssl">
	<title>SSL-Zertifikatsverwaltung</title>
	<para>
		Unter UCS werden sensitive Daten immer verschlüsselt über das Netzwerk
		übertragen, zum Beispiel durch die Verwendung von SSH für den Login auf Systeme
		oder durch Verwendung von Protokollen auf Basis von
		SSL/TLS. (<emphasis>Transport Layer Security (TLS)</emphasis> ist der aktuelle
		Protokollname, der Name des Vorgängerprotokolls <emphasis>Secure Socket Layer
		(SSL)</emphasis> ist jedoch weiterhin gebräuchlicher und wird auch in dieser
		Dokumentation verwendet).
	</para>
	<para>
		SSL/TLS kommt beispielsweise bei der Listener/Notifier-Domänenreplikation
		oder beim HTTPS-Zugriff auf &ucsWeb;n zum Einsatz.
	</para>
	<para>
		Für eine verschlüsselte Kommunikation zwischen zwei Rechnern müssen beide
		Kommunikationspartner die Authentizität des verwendeten Schlüssels prüfen
		können. Dafür besitzt jeder Rechner ein so genanntes
		<emphasis>Rechnerzertifikat</emphasis>, das von einer Zertifizierungsstelle
		(Certification Authority, CA) herausgegeben und signiert wird.
	</para>
	<para>
		UCS bringt seine eigene CA mit, die bei der Installation des &ucsPrimaryDN;
		automatisch eingerichtet wird und von der jedes UCS-System im Rahmen des
		Domänenbeitritts automatisch ein Zertifikat für sich selbst und das öffentliche
		Zertifikat der CA bezieht. Diese CA tritt als Root-CA auf, signiert ihr eigenes
		Zertifikat, und kann Zertifikate für andere Zertifizierungsstellen signieren.
	</para>

	<para>
	  Die Eigenschaften der CA werden bei der Installation basierend auf Systemeinstellungen wie der Locale
	  automatisch festgelegt. Diese Einstellungen können auf dem &ucsPrimaryDN; im UMC-Modul
	  <guimenu>Zertifikats-Einstellungen</guimenu> nachträglich angepasst werden.
	</para>

	<caution>
		<para>
		Besteht die UCS-Domäne aus mehr als einem System müssen durch die Änderung des
		Root-Zertifikats auch alle anderen Rechner-Zertifikate neu ausgestellt werden! Das dafür
		nötige Vorgehen ist in <u:sdb>1183</u:sdb> dokumentiert.
		</para>
	</caution>

	<!-- Wie die Root-CA in eine nachrangige Zertifizierungsstelle (Sub-CA) umgewandelt -->
	<!-- wird und der CA einer anderen oder vorhandenen Organisation untergeordnet -->
	<!-- werden kann, ist in WIKIREF-23879 dokumentiert. -->

	<para>
		Die UCS-CA befindet sich immer auf dem &ucsPrimaryDN;. Auf jedem &ucsBackupDN;
		wird eine Kopie der CA vorgehalten, die über einen Cronjob standardmäßig alle
		20 Minuten mit der CA auf dem &ucsPrimaryDN; synchronisiert wird.
	</para>
	<caution>
		<para>
			Die CA wird nur vom &ucsPrimaryDN; zum &ucsBackupDN; synchronisiert und nicht
			umgekehrt. Es sollte also ausschließlich die CA auf dem &ucsPrimaryDN; verwendet
			werden.
		</para>
	</caution>
	<para>
		Wird ein &ucsBackupDN; zum &ucsPrimaryDN; hochgestuft (siehe <xref
		linkend="domain:backup2master"/>), so kann die CA auf dem dann neuen
		&ucsPrimaryDN; direkt verwendet werden.
	</para>
	<para>
		Das UCS-Root-Zertifikat hat - ebenso wie die damit erstellten
		Rechnerzertifikate - einen bestimmten Gültigkeitszeitraum.
	</para>
	<caution>
		<para>
			Ist dieser Zeitraum abgelaufen, funktionieren Dienste, die ihre
			Kommunikation mit SSL verschlüsseln (z.B. LDAP oder die Domänenreplikation)
			nicht mehr. Es ist deshalb notwendig, die Gültigkeit der Zertifikate
			regelmäßig zu überprüfen und rechtzeitig das Root-Zertifikat zu
			erneuern. Für die Überwachung des Gültigkeitszeitraums wird ein Nagios-Plugin
			bereitgestellt. Außerdem erfolgt beim Öffnen eines UMC-Moduls eine
			Warnmeldung, wenn das Root-Zertifikat bald abläuft (der Warnzeitraum kann mit
			der &ucsUCRV; <envar>ssl/validity/warning</envar> festgelegt werden und beträgt
			standardmäßig 30 Tage).
		</para>
	</caution>

	<para>
	  Die Erneuerung des Root-Zertifikats und der übrigen Rechnerzertifikate ist in
	  <u:sdb>1183</u:sdb> dokumentiert.
	</para>

	<para>
	  Auf UCS-Systemen überprüft ein Cronjob täglich die Gültigkeit des lokalen Rechnerzertifikats
	  und des Root-Zertifikats und schreibt das Ablaufdatum in die &ucsUCR;-Variablen
	  <envar>ssl/validity/host</envar> (Rechnerzertifikat) und <envar>ssl/validity/root</envar>
	  (Root-Zertifikat). Die dort angegebenen Werte spiegeln die Anzahl der Tage seit dem 1.1.1970
	  wieder.
	</para>
	<para>
		In &ucsUMC; wird das effektive Ablaufdatum des Rechner- und Root-Zertifikats angezeigt über
		über das rechte, obere Benutzermenü und den Menüpunkt <guimenu>Lizenz &ar; Lizenzinformation</guimenu>.
	</para>

</section>

<section id="domain:kerberos">
	<title>Kerberos</title>
	<para>
		Kerberos ist ein Authentikationsverfahren um in verteilten Netzen über
		potentiell unsichere Verbindungen eine sichere Identifikation zu erlauben. Alle
		Clients verwenden dabei eine gemeinsame Vertrauensbasis, das <emphasis>Key
		Distribution Centre</emphasis> (KDC). Ein Client authentifiziert sich bei
		diesem KDC und erhält ein Authentizierungs-Token, das sogenannte Ticket, das
		zur Authentizierung innerhalb einer Kerberos-Umgebung (der sogenannten Kerberos
		Realm) verwendet werden kann. Der Name der Kerberos Realm wird im Rahmen der Installation
		des &ucsPrimaryDN; konfiguriert und in der &ucsUCRV; <envar>kerberos/realm</envar>
		gespeichert. Der Name der Kerberos-Realm kann nachträglich nicht angepasst werden.
	</para>
	<para>
		Tickets sind standardmäßig acht Stunden gültig; für eine Kerberos-Domäne
		ist deshalb eine synchrone Systemzeit zwischen den Systemen der Kerberos Realm
		essentiell.
	</para>

	<para>
	  In &ucsUCS; wird die Kerberos-Implementierung Heimdal verwendet. Auf
	  UCS Directory Nodes ohne Samba/AD wird ein eigenständiger Heimdal-Dienst gestartet,
	  während auf Samba/AD-DCs Kerberos durch eine in Samba integrierte Heimdal-Version
	  bereitgestellt wird. Verwendet man eine gemischte Umgebung aus UCS Directory Nodes mit
	  Samba/AD und UCS Directory Nodes ohne Samba/AD, so basieren beide Kerberos-Umgebungen auf
	  identischen Daten (diese werden zwischen Samba/AD und OpenLDAP durch den Univention S4
	  Connector synchronisiert (siehe <xref linkend="windows:s4connector"/>)).
	</para>

	<para>
	  Standardmäßig wird der KDC über einen DNS-Servicerecord ausgewählt. Der von einem System
	  verwendete KDC kann durch die &ucsUCRV; <envar>kerberos/kdc</envar> umkonfiguriert werden.
	  Wird Samba/AD auf einem System der Domäne installiert, wird der Servicerecord umkonfiguriert,
	  so dass nur noch die KDCs auf Samba/AD-Basis angeboten werden. In einer gemischten Umgebung ist
	  es empfehlenswert nur noch die Samba/AD-KDCs zu verwenden.
	</para>

	<para>
		Auf dem &ucsPrimaryDN; läuft der Kerberos-Adminserver, auf dem administrative
		Einstellungen der Domäne vorgenommen werden können. Die meisten Einstellungen
		werden in Univention Corporate Server aus dem LDAP-Verzeichnis bezogen, so dass
		die wichtigste verbleibende Funktion das Ändern von Passwörtern
		darstellt. Diese können durch das Tool <command>kpasswd</command> geändert
		werden und werden dann auch im LDAP verändert. Der Kerberos Adminserver kann
		auf einem System durch die &ucsUCRV; <envar>kerberos/adminserver</envar>
		konfiguriert werden.
	</para>
</section>

<section id="domain:password_hashes">
	<title>Passwort-Hashes im Verzeichnisdienst</title>
	<para>
		Passwort-Hashes von Benutzern werden u.a. im Attribut <property>userPassword</property> im Verzeichnisdienst gespeichert.
		Für die Generierung der Passwort-Hashes wird auf die <function>crypt</function> Bibliotheksfunktion zurückgegriffen. Die eigentliche
		Hash-Funktion kann über die &ucsUCRV; <envar>password/hashing/method</envar> definiert werden,
		standardmäßig wird <function>SHA-512</function> verwendet.
	</para>
	<para>
		Alternativ dazu bietet &ucsUCS; ab <u:erratum release="4.4-7">887</u:erratum> die Möglichkeit <function>bcrypt</function>
		als Hash-Funktion für Benutzerkonten zu verwenden. Dafür muss zunächst auf allen LDAP-Servern die &ucsUCRV;
		<envar>ldap/pw-bcrypt=true</envar> gesetzt werden um das nötige Modul für OpenLDAP zu aktivieren.
		Andernfalls ist eine Anmeldung am LDAP-Server mit einem <function>bcrypt</function> Hash nicht möglich.
		Damit beim Ändern von Passwörtern nun <function>bcrypt</function> Hashes generiert werden,
		muss ebenfalls auf allen Servern die &ucsUCRV; <envar>password/hashing/bcrypt=true</envar> gesetzt werden.
	</para>
	<para>
		Zusätzlich können der <foreignphrase>bcrypt Cost Factor</foreignphrase> und die <function>bcrypt</function>
		Variante über die &ucsUCRV;n <envar>password/hashing/bcrypt/cost_factor</envar> (<literal>12</literal>) und
		<envar>password/hashing/bcrypt/prefix</envar> (<literal>2b</literal>) angepasst werden.
	</para>
	<caution>
		<para>
			<function>bcrypt</function> ist auf maximal 72 Zeichen begrenzt. Für die Generierung der Hashes werden also nur
			die ersten 72 Zeichen des Kennwort verwendet.
		</para>
	</caution>
</section>

<section id="domain:saml">
	<title>SAML Identity Provider</title>
	<para>
	  SAML (Security Assertion Markup Language) ist ein XML-basierter Standard zum Austausch von Authentifizierungsinformationen, der <foreignphrase>Single Sign-On</foreignphrase> über Domänengrenzen hinweg erlaubt.
	  UCS stellt auf dem &ucsPrimaryDN; und den &ucsBackupDN; einen ausfallsicheren SAML Identity Provider bereit.
	  Über ein kryptografisches Zertifikat wird der SAML Identity Provider bei einem externen Dienst fest registriert und vertraut diesem.
	  Der Benutzer authentifiziert sich dann einmalig gegenüber UCS und kann den Dienst ohne erneute Authentifizierung nutzen.
	</para>
	<figure id="domain:saml:samllogin">
		<title>Die <foreignphrase>Single Sign-On</foreignphrase>-Anmeldeseite</title>
		<graphic scalefit="1" width="70%" align="center" fileref="illustrations50/sso_login_de.png"/>
	</figure>
	<para>
		Der SAML 2.0 kompatible UCS Identity Provider wird durch die Integration von <package>simplesamlphp</package> bereitgestellt.
	</para>
	<para>
		Der UCS Identity Provider ist eng in die UCS Domäne eingebunden.
		Daher müssen Rechner, von denen der UCS Identity Provider genutzt werden soll, DNS-Namen in der UCS-Domäne auflösen können.
		Die DNS-Server der Domäne sollten auf allen Clients eingetragen sein, um den zentralen DNS-Namen, im Normalfall <uri>ucs-sso.<replaceable>domainname</replaceable></uri>, auflösen zu können.
	</para>
	<para>
		Der UCS Identity Provider wird auf dem &ucsPrimaryDN; und &ucsBackupDN; mit der Installation automatisch eingerichtet.
		Um die Ausfallsicherheit innerhalb der Domäne zu erhöhen, können weitere Systeme der Rolle &ucsBackupDN; verfügbar gemacht werden.
		Für den ausfallsicheren Zugriff auf den UCS Identity Provider wird standardmäßig der DNS-Eintrag <uri>ucs-sso.<replaceable>domainname</replaceable></uri> registriert.
		Das für diesen Eintrag vorgesehene TLS Zertifikat wird auf allen beteiligten Systemen der Domäne vorgehalten.
		Es wird empfohlen, das Wurzelzertifikat der UCS Domäne auf allen Rechnern, die <foreignphrase>Single Sign-On</foreignphrase> nutzen, zu installieren.
	</para>
	<para>
		Es besteht die Möglichkeit, die SAML-Authentifizierung mit der Kerberos Anmeldung zu verknüpfen. Das bedeutet, dass sich Nutzer mit einem gültigen Kerberos Ticket,
		bspw. nach einer Anmeldung an Windows oder Linux, ohne eine erneute manuelle Authentifizierung am Identity Provider anmelden können.
	</para>
	<para>
		Um die Kerberos Authentifizierung am Identity Provider zuzulassen, muss die &ucsUCRV; <envar>saml/idp/authsource</envar> von <option>univention-ldap</option>
		auf <option>univention-negotiate</option> gesetzt werden. Die Webbrowser müssen entsprechend so konfiguriert werden, so dass das Kerberos Ticket an den SAML Identity
		Provider übertragen wird. Im folgenden beispielhaft für Firefox und den Internet Explorer / Microsoft Edge:
	</para>
	<variablelist>
		<varlistentry>
			<term>Mozilla Firefox</term>
			<listitem>
				<simpara>
						In der erweiterten Firefox Konfiguration, diese ist erreichbar über die Eingabe von <guimenu>about:config</guimenu> in der Firefox Adresszeile,
						muss bei der Option <guimenu>network.negotiate-auth.trusted-uris</guimenu> die Adresse des Identity Providers eingetragen werden, also in der
						Standardeinstellung <uri>ucs-sso.<replaceable>domainname</replaceable></uri>.
				</simpara>
			</listitem>
		</varlistentry>
		<varlistentry>
			<term>Microsoft Internet Explorer</term>
			<term>Microsoft Edge</term>
			<listitem>
				<simpara>
						In der Systemsteuerung müssen die <guimenu>Internetoptionen</guimenu> geöffnet werden und dort wird unter <guimenu>Sicherheit</guimenu>,
						<guimenu>Lokales Intranet</guimenu>, <guimenu>Sites</guimenu>, <guimenu>Erweitert</guimenu> die Adresse des Identity Providers hinzugefügt,
						also in der Standardeinstellung <uri>ucs-sso.<replaceable>domainname</replaceable></uri>.
				</simpara>
			</listitem>
		</varlistentry>
	</variablelist>
	<para>
		Die Kerberos Authentifizierung kann auf bestimmte IP Subnetze beschränkt werden, indem die &ucsUCRV; <envar>saml/idp/negotiate/filter-subnets</envar> beispielsweise auf <literal>127.0.0.0/16,192.168.0.0/16</literal> gesetzt wird.
		Dies ist besonders nützlich, um zu verhindern, dass für Clients, die nicht zur UCS-Domäne gehören, ein Dialog für den Login angezeigt wird.
	</para>

	<section id="domain:saml:ssologin">
	<title>Anmelden per <foreignphrase>Single Sign-On</foreignphrase></title>
	<para>
		Der <foreignphrase>Single Sign-On</foreignphrase> ist der Standard-Login für &ucsWeb;n, sofern <uri>ucs-sso.<replaceable>domainname</replaceable></uri> erreicht werden kann.
		Zum Login werden die Anmeldedaten des Domänenkontos verwendet.
		Für den Login direkt am UCS-System (also ohne <foreignphrase>Single Sign-On</foreignphrase>) gelangt man über den Link <guimenu>Ohne Single Sign-On anmelden</guimenu>.
	</para>
	<para>
		Über die Datei <filename>/usr/share/univention-management-console-login/css/custom.css</filename> kann das Design des Anmeldedialogs
		angepasst werden. Diese Datei wird niemals automatisch überschrieben.
	</para>
	<para>
		Andere Webdienste leiten ebenfalls auf die Anmeldeseite des UCS Identity Providers weiter, wenn ein <foreignphrase>Single Sign-On</foreignphrase> durchgeführt wird.
		Nach erfolgreicher Authentifizierung wird der Benutzer wieder auf die Seite des Webdienstes gesendet werden.
		Diese Dienste müssen wie in <xref linkend="domain:saml:additionalserviceprovider"/> beschrieben registriert werden.
	</para>
	<para>
		Der <foreignphrase>Single Sign-On</foreignphrase> an einem Dienst kann auch vom UCS Identity Provider initiiert werden.
		Dies erspart den Umweg, zunächst den externen Dienst selbst aufzurufen und sich von dort zur Authentifizierung weiterleiten zu lassen.
		Dazu muss der Identity Provider mit einem Link der Form <uri>https://ucs-sso.<replaceable>domainname</replaceable>/simplesamlphp/saml2/idp/SSOService.php?spentityid=<replaceable>[Service provider identifier]</replaceable></uri> aufgerufen werden.
	</para>
	</section>

	<section id="domain:saml:additionalserviceprovider">
	<title>Hinzufügen eines neuen externen Service Providers</title>
	<para>
		Die am UCS Identity Provider registrierten Service Provider können über das UMC-Modul <guimenu>SAML Identity Provider</guimenu> verwaltet werden.
		Benutzer müssen freigeschaltet werden, bevor sie sich am UCS Identity Provider für einen Dienst authentifizieren können.
		Service Provider können auch für Gruppen aktiviert werden, sodass sich alle Benutzer in dieser Gruppe für diesen Dienst authentifizieren können.
		Auf dem <foreignphrase>Tab</foreignphrase> <guimenu>Konto</guimenu> eines Benutzers, oder dem <foreignphrase>Tab</foreignphrase> <guimenu>Allgemein</guimenu> einer Gruppe, muss dazu unter <guimenu>SAML Einstellungen</guimenu> der Service Provider Eintrag hinzugefügt werden.
	</para>
	<para>
		Um den UCS Identity Provider bei einem SAML Service Provider zu registrieren, wird der öffentliche Teil	des <wordasword>SAML-Zertifikats</wordasword> auf dem Service Provider benötigt.
	    Dieses kann über einen Download-Link im UMC-Modul heruntergeladen werden.
		Andere Service Provider benötigen die <wordasword>XML-Metadaten</wordasword> des Identity Providers in Form eines Datei-<foreignphrase>Uploads</foreignphrase>.
		In der Standardkonfiguration kann die XML-Datei unter der URL <uri>https://ucs-sso.<replaceable>domainname</replaceable>/simplesamlphp/saml2/idp/metadata.php</uri> heruntergeladen werden.
	</para>
	<para>
		Die folgenden Attribute können beim anlegen eines neuen Service Provider-Eintrags konfiguriert werden.
	</para>
	<table>
		<title>Allgemeine Felder bei der Anbindung eines Service Providers</title>
		<tgroup cols="2">
			<colspec colnum="1" colname="col1" colwidth="1*"/>
			<colspec colnum="2" colname="col2" colwidth="2*"/>
			<thead>
				<row>
					<entry>Attribut</entry>
					<entry>Beschreibung</entry>
				</row>
			</thead>
			<tbody>
				<row>
					<entry>Service Provider aktivieren</entry>
					<entry>
						Ist diese Option gesetzt, wird die Konfiguration des Service Providers aktiviert und steht für die Anmeldung bereit.
					</entry>

				</row>
				<row>
					<entry>Bezeichner des Service Providers</entry>
					<entry>
						Definiert den internen Namen des Service Providers.
						Dieser wird später an Benutzerobjekt angezeigt und ausgewählt, um Benutzer für die Verbindung freizuschalten.
						Der Bezeichner kann später nicht mehr geändert werden.
					</entry>

				</row>
				<row>
					<entry>Antwort an diese Service Provider URL nach dem Login</entry>
					<entry>
						Nach dem erfolgreichen Login an UCS wird der Browser des Benutzers zurück zum Service Provider geleitet.
						Die Weiterleitung erfolgt an die hier angegebene URL.
					</entry>

				</row>
				<row>
					<entry>Single <foreignphrase>logout</foreignphrase> URL des Service Providers</entry>
					<entry>
						Service Provider können einen URL Endpunkt anbieten, mit dem die Session am Service Provider beendet werden kann.
						Loggt sich der Benutzer am UCS Identity Provider aus, wird über die hier übergebene URL ein <foreignphrase>Logout</foreignphrase> am Service Provider durchgeführt.
					</entry>

				</row>
				<row>
					<entry>Format des <option>NameID</option> Attributs</entry>
					<entry>
						Der Wert <option>NameIDFormat</option>, den der Service Provider erhält.
						Die Dokumentation des Service Providers sollte erwartete Formate erwähnen.
						Beispiel: <option>urn:oasis:names:tc:SAML:2.0:nameid-format:transient</option> oder <option>urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified</option>.
					</entry>

				</row>
				<row>
					<entry>Name des Attributs, das als <option>NameID</option> verwendet wird</entry>
					<entry>
						Hier kann das LDAP Attribut eingetragen werden, das für eine eindeutige Identifizierung des Benutzers am Service Provider verwendet wird, beispielsweise <option>uid</option>.
					</entry>

				</row>
				<row>
					<entry>Name der Organisation des Service Providers</entry>
					<entry>
						Der hier eingetragene Wert wird auf der UCS <foreignphrase>Single Sign-On</foreignphrase>-Login-Seite angezeigt.
						Dem Benutzer wird so dargestellt, für welchen Dienst er sich authentifiziert.
					</entry>

				</row>
				<row>
					<entry>Beschreibung dieses Service Providers</entry>
					<entry>
						Der hier eingetragene Wert wird auf der UCS <foreignphrase>Single Sign-On</foreignphrase>-Login-Seite angezeigt.
						Hier kann eine längere Beschreibung über den Dienst angegeben werden, der auf der Login Seite in einem eigenen Absatz angezeigt wird.
					</entry>

				</row>
			</tbody>
		</tgroup>
	</table>
	<table>
		<title>Erweiterte Felder bei der Anbindung eines Service Providers</title>
		<tgroup cols="2">
			<colspec colnum="1" colname="col1" colwidth="1*"/>
			<colspec colnum="2" colname="col2" colwidth="2*"/>
			<thead>
				<row>
					<entry>Attribut</entry>
					<entry>Beschreibung</entry>
				</row>
			</thead>
			<tbody>
				<row>
					<entry>URL zur Datenschutzrichtlinie des Service Providers</entry>
					<entry>
						Wird hier eine URL eingetragen, wird dem Benutzer ein Link zu dieser Seite auf der UCS Identity Provider-Login-Seite angezeigt.
					</entry>
				</row>
				<row>
					<entry>Erlaube die Übertragung von LDAP Attributen an den Service Provider</entry>
					<entry>
						Standardmäßig überträgt der UCS Identity Provider nur das auf dem Reiter <guimenu>Allgemein</guimenu> angegebene <option>NameID</option> Attribut an den Service Provider.
						Benötigt der Service Provider weitere LDAP-Benutzerattribute, kann diese Checkbox aktiviert werden.
						Die zu übertragenen Attribute werden dann unter <guimenu>Liste der zu übermittelnden LDAP Attribute</guimenu> eingetragen.
					</entry>
				</row>
				<row>
					<entry>Der Wert des <option>Formatfeldes</option> für Attribute</entry>
					<entry>
						Sollen die übertragenen Attribute mit einem besonderen <option>Formatwert</option> übertragen werden, kann dieser hier eingetragen werden.
						Beispiel: <option>urn:oasis:names:tc:SAML:2.0:nameid-format:transient</option> oder <option>urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified</option>.
					</entry>
				</row>
				<row>
					<entry>Liste der zu übermittelnden LDAP-Attribute</entry>
					<entry>
						Hier kann jedes zu übertragende LDAP-Attribut eingetragen werden.
						Zu jedem dieser Attribute können ebenfalls ein oder mehrere Service Attribut-Namen im nebenstehenden Feld definiert werden.
						Diese dienen zur Übersetzung des LDAP Attribut-Namen für den Service-Provider.
						Mehrere Einträge müssen durch Kommata getrennt werden.
						Damit der UCS Identity Provider die angegebenen Attribute verarbeiten kann, müssen sie zusätzlich am LDAP Objekt <uri>id=default-saml-idp,cn=univention,<replaceable>base DN</replaceable></uri> eingetragen werden.
						Dort eingetragene LDAP Attribute können vom Identity Provider ausgelesen und übertragen werden.
					</entry>
				</row>
			</tbody>
		</tgroup>
	</table>
	</section>
	<section id="domain:saml:extendedconfiguration">
	<title>Erweiterte Konfiguration</title>
	<para>
		In manchen Umgebungen kann es erforderlich sein, dass der UCS Identity Provider mehrere logische Identity Provider Instanzen bereitstellt.
		Die logische Trennung wird erreicht, indem der Identity Provider unterschiedliche URIs als Endpunkt anbietet.
		Der standardmäßig eingerichtete Endpunkt ist <uri>https://ucs-sso.<replaceable>domainname</replaceable>/simplesamlphp/saml2/idp/metadata.php</uri>.
		Weitere Einträge können durch das Setzen von &ucsUCRV;n in der Form <envar>saml/idp/entityID/supplement/<replaceable>identifier</replaceable>=true</envar> erzeugt werden.
		Diese müssen auf allen Servern, die den UCS Identity Provider zur Verfügung stellen, gesetzt werden.
		Typischerweise sind dies der &ucsPrimaryDN; und alle Server der Rolle &ucsBackupDN;.
		Anschließend muss der <systemitem class="service">apache2</systemitem> Dienst neu geladen werden.
		Um beispielsweise einen weiteren Eintrag unter der URI <uri>https://ucs-sso.<replaceable>domainname</replaceable>/simplesamlphp/<replaceable>secondIDP</replaceable>/saml2/idp/metadata.php</uri> einzurichten, muss die &ucsUCRV; <envar>saml/idp/entityID/supplement/secondIDP=true</envar> gesetzt werden.
	</para>
	</section>
</section>

<section id="domain:oidc">
  <title><application>OpenID Connect Provider</application></title>
  <para>
	UCS bietet die Möglichkeit, einen <application>OpenID Connect Provider</application> zu installieren, mit dessen Hilfe externe Web-Dienste die Benutzeranmeldung über das <application>OpenID Connect</application> (OIDC) Protokoll an das UCS Identity Management delegieren können.
	Die <application>OpenID Connect Provider</application> App kann über das App Center installiert werden.
	Der Dienst wird von der Software <application>Kopano Konnect</application> bereitgestellt.
  </para>
  <para>
	Die App kann grundsätzlich auf allen Systemrollen installiert werden.
	Bei einer Installation auf einem UCS System der Rolle &ucsPrimaryDN; oder &ucsBackupDN; wird der <application>OpenID Connect Provider</application> unter dem DNS Eintrag für den <foreignphrase>Single Sign-On</foreignphrase> verfügbar gemacht, im Normalfall ist dies <uri>ucs-sso.<replaceable>domain.name</replaceable></uri>.
	Wird die App auf einer anderen Systemrolle installiert, kann der Provider statt dessen direkt über den Hostnamen erreicht werden.
	Es sollte sichergestellt werden, dass die App auf allen Servern installiert ist, die unter dem <uri>ucs-sso</uri> DNS CNAME erreichbar sind.
	Die Synchronisation von Session Informationen zwischen mehreren Instanzen des OIDC Providers ist nicht vorkonfiguriert.
	Wenn Login Probleme bei Apps in dieser Konfiguration auftreten, empfehlen wir den OIDC Provider nur auf einem System zu betreiben, und den <uri>ucs-sso</uri> DNS CNAME auf dieses System zu beschränken, oder den Univention Support zu kontaktieren.
  </para>
  <para>
	Um externe Web-Dienste per <application>OpenID Connect</application> an UCS anzubinden, muss für diesen Dienst ein bestimmtes Objekt des Typs <classname>oidc/rpservice</classname> im UCS Verzeichnisdienst vorhanden sein.
	Dies kann im UMC-Modul <guimenu>LDAP-Verzeichnis</guimenu> im Container <uri>cn=oidc</uri> angelegt werden,
	der sich unterhalb des Containers <uri>cn=univention</uri> befindet.
	Hier kann über die Schaltfläche <guimenu>Hinzufügen</guimenu> und die Auswahl
	<guimenu>OpenID Connect Relying Party Service</guimenu> ein neuer Dienst registriert werden.
  </para>
  <para>
	Das gleiche ist auch über die Kommandozeile möglich:
  </para>
  <programlisting>
udm oidc/rpservice create --set name=&lt;UCS_interner_Bezeichner&gt; \
  --position="cn=oidc,cn=univention,$(ucr get ldap/base)" \
  --set clientid=&lt;ClientID&gt; \
  --set clientsecret=&lt;Ein_langes_Passwort&gt; \
  --set trusted=yes \
  --set applicationtype=web \
  --set redirectURI=&lt;URL_aus_Dokumentation_des_Dienstes&gt;
  </programlisting>
  <para>
	Die Parameter des Aufrufs sind:
  </para>
  <variablelist>
	<varlistentry>
	  <term><varname>name</varname></term>
	  <listitem>
		<simpara>
		  der beim Login im Webinterface angezeigte Dienstname.
		</simpara>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><varname>clientid</varname></term>
	  <term><varname>secret</varname></term>
	  <listitem>
		<simpara>
		  müssen hier und beim angebundenen Dienst identisch sein (<foreignphrase>shared secret</foreignphrase>).
		</simpara>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><varname>trusted</varname></term>
	  <listitem>
		<simpara>
		  sollte standardmäßig auf <literal>yes</literal> gesetzt werden.
		  Andernfalls wird dem Benutzer eine Bitte um Bestätigung zur Übertragung seiner Benutzerattribute an den Dienst angezeigt.
		</simpara>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><varname>applicationtype</varname></term>
	  <listitem>
		<simpara>
		  sollte für Internetdienste auf den Wert <literal>web</literal> gesetzt werden.
		</simpara>
	  </listitem>
	</varlistentry>
	<varlistentry>
	  <term><varname>redirectURI</varname></term>
	  <listitem>
		<simpara>
		  URL des Login-Endpunkts, die in der Dokumentation des jeweiligen angebundenen Dienstes zu finden ist.
		  Ist ein Dienst über mehrere URLs erreichbar oder soll er auch per IP Adresse aufrufbar sein, müssen alle möglichen Adressen zum Attribut <varname>redirectURI</varname> hinzugefügt werden.
		  Das Feld kann daher mehrfach definiert werden, wobei jeder einzelne Wert eine gültige URL enthalten muss.
		</simpara>
	  </listitem>
	</varlistentry>
  </variablelist>
  <para>
	Der angebundene Web-Dienst braucht für seine Konfiguration noch Informationen über die <application>OpenID Connect</application> Endpunkte der Provider-App.
	Diese sind bei installierter Provider-App unter der URL <uri>https://ucs-sso.<replaceable>domain.name</replaceable>/.well-known/openid-configuration</uri> einsehbar.
	Wurde die Provider-App auf einem anderen System als &ucsPrimaryDN; oder &ucsBackupDN; installiert, ist wie oben beschrieben statt <uri>ucs-sso.domain.name</uri> der FQDN des jeweiligen Servers zu verwenden.
  </para>
  <para>
	Bei der Verwendung von <application>OpenID Connect</application> ist auf korrekte, auflösbare DNS Namen und verifizierbare Zertifikate zu achten.
	Zu beachten ist dies insbesondere bei Client-Rechnern von Endbenutzern, die sowohl auf die per DNS auflösbaren Hostnamen des Web-Dienst als auch auf den <application>OpenID Connect Provider</application> zugreifen müssen.
	Außerdem müssen die extern angebundenen Web-Dienste eine Verbindung zum <application>OpenID Connect Provider</application> herstellen können, um darüber die Benutzerattribute abrufen zu können.
  </para>
  <para>
	Im speziellen Fall, wo der DNS Namen des OIDC-Providers geändert werden soll, muss zunächst der entsprechende Wert in den App Einstellungen der <application>OpenID Connect Provider</application> App angepasst werden.
	Da es diverse Szenarien für die Erreichbarkeit des Providers nach der Änderung des DNS Namens gibt, kann keine automatische Änderung der Webserverkonfiguration vorgenommen werden.
	Es muss so zum Beispiel je nach konfiguriertem DNS Namen noch die Apache Konfiguration unter UCS angepasst werden.
	Die Konfigurationsdatei <filename>/etc/apache2/conf-available/openid-connect-provider.conf</filename> muss unter dem gesetzten DNS Namen in einem Virtual Host verfügbar gemacht werden.
  </para>
  <para>
	Mit Version 2 der <application>OIDC-Provider App</application> funktioniert die Authentifizierung an <application>OpenID Connect</application> über den SAML Identity Provider der UCS Domäne.
	Ist der SAML Identity Provider von der Standardkonfiguration abweichend nicht unter <uri>https://ucs-sso.<replaceable>domain.name</replaceable></uri> erreichbar, muss in den App Einstellungen die URL korrekt eingetragen werden, unter der die SAML IdP Metadaten für die UCS Domäne abgerufen werden können.
	Bei inkorrekter Konfiguration dieser URL startet der <application>OpenID Connect Provider</application> nicht.
  </para>
  <para>
	Mit der Authentifizierung per SAML ist die Autorisierung für die Nutzung des <application>OpenID Connect Providers</application> und damit zu allen per OIDC angebundenen Apps über SAML Berechtigungen steuerbar.
	Standardmäßig wird bei der Installation der App die Gruppe <systemitem class="groupname">Domänenbenutzer</systemitem> für den Zugriff freigeschaltet.
	Wenn diese Berechtigung entfernt werden soll, muss zusätzlich in den App Einstellungen die entsprechende Option aktiviert werden, damit die Berechtigung nicht automatisch erneut hinzugefügt wird.
  </para>
  <para>
	Der <application>OpenID Connect Provider</application> protokolliert Aktionen über den Docker Daemon.
	Die Ausgaben können beispielsweise über das Kommando <command>univention-app logs openid-connect-provider</command> eingesehen werden.
  </para>
</section>

<section id="domain:backup2master">
	<title>Umwandlung eines &ucsBackupDN; zum neuen &ucsPrimaryDN;</title>
	<para>
		Eine UCS Domäne hat immer genau einen &ucsPrimaryDN;, kann aber beliebig viele
		&ucsBackupDN; beinhalten. Ein &ucsBackupDN; speichert alle Domänendaten und alle
		SSL-Sicherheitszertifikate als Kopie, im Gegensatz zum &ucsPrimaryDN;
		können jedoch keine schreibenden Änderungen vorgenommen werden.
	</para>
	<para>
		Jeder &ucsBackupDN; kann zu einem &ucsPrimaryDN; umgewandelt werden. Hierfür
		gibt es zwei typische Anwendungsfälle:
	</para>
	<itemizedlist>
		<listitem>
			<simpara>
			Im Notfall nach einem Hardwareausfall des &ucsPrimaryDN;
			</simpara>
		</listitem>
		<listitem>
			<simpara>
			Zum geplanten Ersetzen des &ucsPrimaryDN; durch neue Hardware oder Wechsel der Architektur von i386 auf amd64
			</simpara>
		</listitem>
	</itemizedlist>
	<caution>
		<para>
		Die Umwandlung eines &ucsBackupDN; in einen &ucsPrimaryDN; ist ein tiefgreifender
		Konfigurationsschritt und sollte gründlich vorbereitet werden! Die Umwandlung kann nicht rückgängig
		gemacht werden.
		</para>
		<para>
		Der zu ersetzende &ucsPrimaryDN; muss vor Beginn der Umwandlung abgeschaltet werden und darf weder während
		der Umwandlung noch im Anschluss daran wieder in Betrieb genommen werden!
		</para>
		<para>
		Im Vorfeld muss die installierte Software sowie die aktuelle Konfiguration zwischen &ucsPrimaryDN; und &ucsBackupDN; abgeglichen werden.
		Wenn der &ucsPrimaryDN; wegen eines Ausfalls nicht mehr verfügbar ist, muss eine Sicherung herangezogen werden.
		Im Nachgang an die Umwandlung müssen alle evtl. verbliebenen Referenzen auf den alten &ucsPrimaryDN; entfernt bzw. korrigiert werden.
		</para>
	</caution>
	<para>
		Die Umwandlung umfasst primär die Umstellung der für die Authentifizierung
		relevanten Dienste wie LDAP, DNS, Kerberos und Samba. Der Abgleich der
		installierten Software muss manuell erfolgen (über die UMC-Module
		<guimenu>App Center</guimenu> und <guimenu>Paket-Verwaltung</guimenu>).
		Wenn also z.B. auf dem vorherigen &ucsPrimaryDN; die
		Mailkomponente installiert war, ist diese nach der Umwandlung nicht automatisch
		auf dem neuen &ucsPrimaryDN; verfügbar.
		Um den Umfang der Nachbereitung möglichst gering zu halten, sollte im Vorfeld <xref
		linkend="domain:fault-tolerant"/> beachtet werden.
	</para>
	<para>
		  Wurden auf dem &ucsPrimaryDN; zusätzliche LDAP-Schema-Pakete installiert, so
		müssen diese vor der Umwandlung auch auf dem &ucsBackupDN; installiert werden.
		Die Paketliste des alten &ucsPrimaryDN; sollte vor der Umstellung gesichert werden, um einen
		Abgleich der installierten Pakete zu erlauben. Die Paketliste kann mit dem folgenden Befehl
		erstellt werden:
	</para>
		<programlisting language="sh">
dpkg --get-selections \* > dpkg.selection
		</programlisting>
	<para>
		Die so auf dem &ucsPrimaryDN; erstellte Datei sollte mit einer ebenso erstellten Datei des &ucsBackupDN;
		verglichen und benötigte Pakete auf dem &ucsBackupDN; nachinstalliert werden. Insbesondere alle Pakete,
		die ein LDAP-Schema installieren sind zwingend erforderlich. Eine Auflistung dieser LDAP-Schema-Pakete
		lässt sich wie folgt erstellen:
	</para>
		<programlisting language="sh">
dpkg -S /etc/ldap/schema/*.schema \
  /usr/share/univention-ldap/schema/*.schema
		</programlisting>
	<para>
		Um einfach alle installierten Pakete des &ucsPrimaryDN; auch auf dem &ucsBackupDN; zu installieren,
		kann die zuvor auf dem &ucsPrimaryDN; erstellte Datei <filename>dpkg.selection</filename> mit
		folgenden Befehlen verwendet werden:
	</para>
		<programlisting language="sh">
dpkg --set-selections &lt; dpkg.selection
apt-get dselect-upgrade
		</programlisting>
	<para>
		Darüber hinaus sollte der &ucsUCR;-Datenbestand gesichert werden, um
		Konfigurationsanpassungen auch auf dem neuen &ucsPrimaryDN; abgleichen zu können. Folgende Dateien
		des &ucsPrimaryDN; sind dazu mit denen auf dem &ucsBackupDN; zu vergleichen:
	</para>
		<programlisting language="sh">
/etc/univention/base.conf
/etc/univention/base-forced.conf
		</programlisting>
	<para>
		Eine nächtliche Sicherung dieser Dateien findet sich auch in <filename>/var/univention-backup/ucr-backup_%Y%m%d.tgz</filename>
	</para>
	<para>
		Die Umwandlung eines &ucsBackupDN; zum neuen &ucsPrimaryDN; erfolgt dann durch Aufruf des
		Befehls <command>/usr/lib/univention-ldap/univention-backup2master</command> auf dem &ucsBackupDN;.
		Das System muss anschließend neu gestartet werden. Die Umstellung wird in der Logdatei
		<filename>/var/log/univention/backup2master.log</filename> protokolliert.
	</para>
	<para>
		Folgende Schritte führt der Befehl <command>univention-backup2master</command> der Reihe nach aus:
	</para>
	<itemizedlist>
		<listitem>
			<simpara>
			Prüfung der Umgebung: Bei dem System muss es sich um einen &ucsBackupDN; handeln, der der Domäne bereits beigetreten ist.
			Zudem wird sichergestellt, dass der &ucsPrimaryDN; über DNS auflösbar sowie dass eine Verbindung zum Repository-Server möglich ist.
			Außerdem darf der &ucsPrimaryDN; nicht mehr im Netzwerk erreichbar sein.
			</simpara>
		</listitem>
		<listitem>
			<simpara>
			Nun werden die wichtigsten Dienste OpenLDAP, Samba, Kerberos sowie &ucsUDN; und Listener gestoppt,
			elementare &ucsUCRV; wie <envar>ldap/master</envar> und <envar>server/role</envar> umgestellt, das UCS Root-Zertifikat
			vom Webserver des &ucsBackupDN; abrufbar gemacht und die oben genannten Dienste wieder gestartet.
			</simpara>
		</listitem>
		<listitem>
			<simpara>
			Der DNS SRV Eintrag <literal>kerberos-adm</literal> wird vom alten auf den neuen &ucsPrimaryDN; geändert
			</simpara>
		</listitem>
		<listitem>
			<simpara>
			Sofern vorhanden, wird der Univention S4 Connector (siehe <xref linkend="windows:s4connector"/>) vom Rechnerobjekt des
			alten &ucsPrimaryDN; entfernt und auf dem neuen &ucsPrimaryDN; zur erneuten Konfiguration vorgemerkt.
			</simpara>
		</listitem>
		<listitem>
			<simpara>
			Im OpenLDAP wird die Serverrolle des neuen &ucsPrimaryDN; auf <classname>domaincontroller_master</classname> geändert.
			Ebenfalls wird der DNS SRV Eintrag <literal>_domaincontroller_master._tcp</literal> korrigiert.
			</simpara>
		</listitem>
		<listitem>
			<simpara>
			Sofern vorhanden werden die Einträge des alten &ucsPrimaryDN; aus der lokalen Samba-Datenbank des neuen &ucsPrimaryDN; entfernt.
			Zudem werden die FSMO-Rollen auf den neuen &ucsPrimaryDN; übertragen.
			</simpara>
		</listitem>
		<listitem>
			<simpara>
			Anschließend wird das Rechnerobjekt des alten &ucsPrimaryDN; im OpenLDAP gelöscht.
			</simpara>
		</listitem>
		<listitem>
			<simpara>
			Nun wird das LDAP nach Referenzen auf den alten &ucsPrimaryDN; durchsucht. Alle gefundenen Referenzen werden angezeigt
			und es wird eine Korrektur vorgeschlagen, welche einzeln geprüft und bestätigt werden muss, bspw. weitere DNS-Einträge.
			</simpara>
		</listitem>
		<listitem>
			<simpara>
			Zum Abschluss wird das Paket <package>univention-server-backup</package> durch <package>univention-server-master</package> ersetzt.
			</simpara>
		</listitem>
	</itemizedlist>
	<para>
		Im Anschluss sollte sowohl &ucsUCR; auf allen UCS-Systemen der Domäne als auch das LDAP auf dem jetzt neuen &ucsPrimaryDN;
		hinsichtlich Verweisen auf den Namen und die IP-Adresse des alten &ucsPrimaryDN; überprüft und diese ggf. angepasst werden.
	</para>
</section>

<section id="domain:fault-tolerant">
	<title>Fehlertolerante Domain Einrichtung</title>
	<para>
		Einige Dienste in einer Domäne sind zentral für das Funktionieren von deren Mitgliedern.
		Redundanz ist ein Mittel um diesen potenziellen Bruchstellen (<wordasword>single points of failure</wordasword>) zu entfernen.
		Ein Artikel in der Univention Support Datenbank erklärt das Vorgehen um die Dienste LDAP, Kerberos, DNS, DHCP und Active Directory-kompatible Domain Controller abzusichern: <u:sdb>1349</u:sdb>.
	</para>
</section>

<section id="domain:admindiary">
	<title>Protokollierung von Aktivitäten in der Domäne</title>
	<para>
		Über die <foreignphrase>Admin Diary</foreignphrase>-App besteht die Möglichkeit, wichtige Ereignisse in der Domäne zu protokollieren.
		Dazu gehören unter anderem:
	</para>
	<itemizedlist>
		<listitem><simpara>
			Das Anlegen, Verschieben, Verändern oder Löschen von Benutzern und anderen Objekten über &ucsUDM;
		</simpara></listitem>
		<listitem><simpara>
			Installation, Update und Deinstallation von Apps
		</simpara></listitem>
		<listitem><simpara>
			Server-Passwort-Änderungen
		</simpara></listitem>
		<listitem><simpara>
			Start, Ende und eventuelle Fehlschläge vom Domänenbeitritt
		</simpara></listitem>
		<listitem><simpara>
			Start und Ende von UCS Updates
		</simpara></listitem>
	</itemizedlist>
	<figure id="domain-ldap:adminndiary:list">
		<title>Ansicht der Ereignisse im <foreignphrase>Admin Diary</foreignphrase></title>
		<graphic scalefit="1" width="80%" align="center" fileref="illustrations50/admindiary-list_de.png"/>
	</figure>
	<para>
		<xref linkend="domain-ldap:adminndiary:list"/> zeigt, wie die Ereignisse im UMC-Modul
		<guimenu>Admin Diary</guimenu> dargestellt werden.
		Die angezeigten Einträge werden standardmäßig wochenweise gruppiert und können über das Suchfeld weiter eingegrenzt werden.
		Durch das Auswählen eines Eintrags gelangt man zu einer Detailansicht, wie sie in <xref linkend="domain-ldap:adminndiary:detail"/> zu sehen ist.
		Dieser kann man weitere Details zum Wo und Wann entnehmen.
		Zudem besteht die Möglichkeit, das Ereignis zu kommentieren.
	</para>
	<figure id="domain-ldap:adminndiary:detail">
		<title>Detailansicht im <foreignphrase>Admin Diary</foreignphrase></title>
		<graphic scalefit="1" width="80%" align="center" fileref="illustrations50/admindiary-detail_de.png"/>
	</figure>
	<para>
		Die App besteht aus zwei Komponenten:
	</para>
	<variablelist>
		<varlistentry>
			<term><foreignphrase>Admin Diary</foreignphrase> Backend</term>
			<listitem><simpara>
				Das Backend muss auf einem System in der Domäne installiert sein, bevor das Frontend installiert werden kann.
				Es beinhaltet eine Anpassung für <package>rsyslog</package> und schreibt in eine zentrale Datenbank, standardmäßig PostgreSQL.
				Falls MariaDB oder MySQL vorher auf dem Zielsystem installiert ist, dann wird es statt PostgreSQL verwendet.
			</simpara></listitem>
		</varlistentry>
		<varlistentry>
			<term><foreignphrase>Admin Diary</foreignphrase> Frontend</term>
			<listitem><simpara>
				Auch das Frontend muss mindestens einmal installiert sein, kann aber öfter installiert werden.
				Das Frontend beinhaltet das UMC-Modul <guimenu>Admin Diary</guimenu>, um die Einträge anzuzeigen und zu kommentieren.
				Wenn es nicht auf dem selben System installiert werden soll, auf dem das Backend läuft, dann muss der Zugriff auf die zentrale Datenbank
				manuell eingerichtet werden.
				Die dazu notwendigen Schritte sind in einem <ulink url="https://help.univention.com/t/admin-diary-how-to-seperate-frontend-and-backend/11331">separaten Artikel</ulink> beschrieben.
			</simpara></listitem>
		</varlistentry>
	</variablelist>
</section>

</chapter>
